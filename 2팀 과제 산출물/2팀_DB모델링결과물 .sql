-- 테이블 생성 실행 -------------------------------------------------------
--○ 테이블 생성
-- 테이블 생성
-- 테이블명: PROF
CREATE TABLE PROF
( PF_ID     VARCHAR2(20)      
, PF_NAME   VARCHAR2(20)    CONSTRAINT  PF_PF_NAME_NN  NOT NULL
, PF_SSN    VARCHAR2(14)        CONSTRAINT  PF_PF_SSN_NN   NOT NULL
, PF_PW     VARCHAR2(20)    CONSTRAINT  PF_PF_PW_NN    NOT NULL
, PF_DATE   DATE            DEFAULT SYSDATE    CONSTRAINT  PF_PF_DATE_NN  NOT NULL
, CONSTRAINT PF_PF_ID_PK PRIMARY KEY(PF_ID)
, CONSTRAINT PF_PF_SSN_UK UNIQUE(PF_SSN)
, CONSTRAINT PF_PF_PW_CK CHECK (LENGTH(PF_PW) BETWEEN 7 AND 12)
, CONSTRAINT PF_PF_SSN_CK CHECK (LENGTH(PF_SSN) = 14)
);
--==>> Table PROF이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: STUD
CREATE TABLE STUD
( ST_ID     VARCHAR2(20)
, ST_PW     VARCHAR2(20)    CONSTRAINT ST_ST_PW_NN NOT NULL
, ST_NAME   VARCHAR2(20)    CONSTRAINT ST_ST_NAME_NN NOT NULL
, ST_SSN    VARCHAR2(14)    CONSTRAINT ST_ST_SSN_NN NOT NULL
, ST_DATE   DATE            DEFAULT SYSDATE     CONSTRAINT ST_ST_DATE_NN NOT NULL
, CONSTRAINT ST_ST_ID_PK PRIMARY KEY(ST_ID)
, CONSTRAINT ST_ST_SSN_UK UNIQUE(ST_SSN)
, CONSTRAINT ST_ST_PW_CK CHECK (LENGTH(ST_PW) BETWEEN 7 AND 12)
, CONSTRAINT ST_ST_SSN_CK CHECK (LENGTH(ST_SSN) = 14)
);
--==>> Table STUD이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: COURSE
CREATE TABLE COURSE
( CR_CODE   VARCHAR2(10)    
, CR_NAME   VARCHAR2(100)    CONSTRAINT CR_CR_NAME_NN NOT NULL
, CONSTRAINT CR_CR_CODE_PK PRIMARY KEY(CR_CODE)
);
--==>>Table COURSE이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: SUB
CREATE TABLE SUB
( SUB_CODE  VARCHAR2(10)    
, SUB_NAME  VARCHAR2(100)    CONSTRAINT SUB_SUB_NAME_NN NOT NULL
, CONSTRAINT SUB_SUB_CODE_PK  PRIMARY KEY(SUB_CODE)
);
--==>> Table SUB이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: TEXTBOOK
CREATE TABLE TEXTBOOK
( TB_CODE   VARCHAR2(10)    
, TB_NAME   VARCHAR2(100)    CONSTRAINT TB_TB_NAME_NN  NOT NULL
, CONSTRAINT TB_TB_CODE_PK PRIMARY KEY(TB_CODE)
);
--==>> Table TEXTBOOK이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: CLASS
CREATE TABLE CLASS
( CL_CODE   VARCHAR2(20)
, CL_NAME   VARCHAR2(20)    CONSTRAINT CL_CL_NAME_NN NOT NULL
, CONSTRAINT CL_CL_CODE_PK PRIMARY KEY(CL_CODE)
);
--==>> Table CLASS이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: ADMIN_ROLE
CREATE TABLE ADMIN_ROLE
( AR_CODE   VARCHAR2(10)
, AR_NAME   VARCHAR2(20)    CONSTRAINT AR_AR_NAME_NN NOT NULL
, CONSTRAINT AR_AR_CODE_PK PRIMARY KEY(AR_CODE)
);
--==>> Table ADMIN_ROLE이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: DROP_REASON
CREATE TABLE DROP_REASON
( DR_CODE   VARCHAR2(10)
, DR_REASON VARCHAR2(20)    CONSTRAINT DR_DR_REASON_NN NOT NULL
, CONSTRAINT DR_DR_CODE_PK PRIMARY KEY(DR_CODE)
);
--==>> Table DROP_REASON이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: ADMIN
CREATE TABLE ADMIN
(
  AD_ID      VARCHAR2(20)  CONSTRAINT AD_AD_ID_NN NOT NULL
, AD_PW      VARCHAR2(20)  CONSTRAINT AD_AD_PW_NN NOT NULL    
, AD_NAME    VARCHAR2(20)  CONSTRAINT AD_AD_NAME_NN NOT NULL    
, AD_SSN     VARCHAR2(14)  CONSTRAINT AD_AD_SSN_NN NOT NULL
, AD_DATE    DATE          DEFAULT SYSDATE       CONSTRAINT AD_AD_DATE_NN NOT NULL       
, AR_CODE    VARCHAR2(10)  CONSTRAINT AD_AR_CODE_NN NOT NULL
, CONSTRAINT AD_AD_ID_PK PRIMARY KEY(AD_ID)
, CONSTRAINT AD_AR_CODE_FK FOREIGN KEY(AR_CODE)
            REFERENCES ADMIN_ROLE(AR_CODE)
, CONSTRAINT AD_AD_SSN_UK UNIQUE(AD_SSN)
, CONSTRAINT AD_AD_PW_CK CHECK (LENGTH(AD_PW) BETWEEN 7 AND 12)
, CONSTRAINT AD_AD_SSN_CK CHECK (LENGTH(AD_SSN) = 14)
);
--==>> Table ADMIN이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: OPEN_COURSE
CREATE TABLE OPEN_COURSE
(
 OC_CODE    VARCHAR2(10)  CONSTRAINT OC_OC_CODE_NN NOT NULL  
,CR_CODE    VARCHAR2(10)  CONSTRAINT OC_CR_CODE_NN NOT NULL
,OC_SDATE   DATE          CONSTRAINT OC_OC_SDATE_NN NOT NULL
,OC_EDATE   DATE          CONSTRAINT OC_OC_EDATE_NN NOT NULL
,CL_CODE    VARCHAR2(20)  CONSTRAINT OC_CL_CODE_NN NOT NULL
,OC_DATE    DATE          DEFAULT SYSDATE      CONSTRAINT OC_OC_DATE_NN NOT NULL
,CONSTRAINT OC_OC_CODE_PK PRIMARY KEY(OC_CODE)
,CONSTRAINT OC_CR_CODE_FK FOREIGN KEY(CR_CODE)
            REFERENCES COURSE(CR_CODE)
,CONSTRAINT OC_CL_CODE_FK FOREIGN KEY(CL_CODE)
            REFERENCES CLASS(CL_CODE)
,CONSTRAINT OC_OC_DATE_CK CHECK(OC_SDATE <= OC_EDATE)
);
--==>> Table ADMIN이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: OPEN_SUB
CREATE TABLE OPEN_SUB
(
 OS_CODE    VARCHAR2(10)  CONSTRAINT OS_OS_CODE_NN NOT NULL
,OC_CODE    VARCHAR2(10)  CONSTRAINT OS_OC_CODE_NN NOT NULL   
,PF_ID      VARCHAR2(20)  CONSTRAINT OS_PF_ID_NN NOT NULL
,SUB_CODE   VARCHAR2(10)  CONSTRAINT OS_SUB_CODE_NN NOT NULL  
,OS_SDATE   DATE          CONSTRAINT OS_OS_SDATE_NN NOT NULL    
,OS_EDATE   DATE          CONSTRAINT OS_OS_EDATE_NN NOT NULL    
,TB_CODE    VARCHAR2(10)  CONSTRAINT OS_TB_CODE_NN NOT NULL 
,ATT_WEIGHT NUMBER(3)     
,WRT_WEIGHT NUMBER(3)     
,PRC_WEIGHT NUMBER(3)     
,OS_DATE    DATE          DEFAULT SYSDATE      CONSTRAINT OS_OS_DATE_NN NOT NULL                  
, CONSTRAINT OS_OS_CODE_PK PRIMARY KEY(OS_CODE)
, CONSTRAINT OS_OC_CODE_FK FOREIGN KEY(OC_CODE)
            REFERENCES OPEN_COURSE(OC_CODE)
, CONSTRAINT OS_PF_ID_FK FOREIGN KEY(PF_ID)
            REFERENCES PROF(PF_ID)
, CONSTRAINT OS_SUB_CODE_FK FOREIGN KEY(SUB_CODE)
            REFERENCES SUB(SUB_CODE)
, CONSTRAINT OS_TB_CODE_FK FOREIGN KEY(TB_CODE)
            REFERENCES TEXTBOOK(TB_CODE)
, CONSTRAINT OS_OC_SUB_CUK UNIQUE(OC_CODE,SUB_CODE)
, CONSTRAINT OS_ATT_CK CHECK(ATT_WEIGHT BETWEEN 0 AND 100) 
, CONSTRAINT OS_WRT_CK CHECK(WRT_WEIGHT BETWEEN 0 AND 100)
, CONSTRAINT OS_PRC_CK CHECK(PRC_WEIGHT BETWEEN 0 AND 100)
, CONSTRAINT OS_OS_DATE_CK CHECK(OS_SDATE <= OS_EDATE)
, CONSTRAINT OS_SUM_WEIGHT_CK CHECK(ATT_WEIGHT + WRT_WEIGHT + PRC_WEIGHT = 100)
);
--==>> Table OPEN_SUB이(가) 생성되었습니다.



-- 테이블 생성
-- 테이블명: ENROLLMENT
CREATE TABLE ENROLLMENT
(
 ER_CODE    VARCHAR2(10)    CONSTRAINT ER_ER_CODE_NN NOT NULL
,OC_CODE    VARCHAR2(10)    CONSTRAINT ER_OC_CODE_NN NOT NULL   
,ST_ID      VARCHAR2(20)    CONSTRAINT ER_ST_ID_NN NOT NULL     
,ER_DATE    DATE            DEFAULT SYSDATE       CONSTRAINT ER_ER_DATE_NN NOT NULL
,CONSTRAINT ER_ER_CODE_PK PRIMARY KEY(ER_CODE)
,CONSTRAINT ER_OC_CODE_FK FOREIGN KEY(OC_CODE)
            REFERENCES OPEN_COURSE(OC_CODE)
,CONSTRAINT ER_ST_ID_FK FOREIGN KEY(ST_ID)
            REFERENCES STUD(ST_ID)
,CONSTRAINT ER_OC_ST_CUK UNIQUE(OC_CODE,ST_ID)
);
--==>> Table ENROLLMENT이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: DROP_OUT
CREATE TABLE DROP_OUT
(
 DO_CODE    VARCHAR2(10)    CONSTRAINT DO_OUT_DO_CODE_NN NOT NULL
,ER_CODE    VARCHAR2(10)    CONSTRAINT DO_OUT_ER_CODE_NN NOT NULL   
,DO_DATE    DATE            DEFAULT SYSDATE    CONSTRAINT DO_OUT_DO_DATE_NN NOT NULL
,DR_CODE    VARCHAR2(10)    CONSTRAINT DO_OUT_DR_CODE_NN NOT NULL
,CONSTRAINT DROP_DO_CODE_PK PRIMARY KEY(DO_CODE)
,CONSTRAINT DO_ER_CODE_FK FOREIGN KEY(ER_CODE)
            REFERENCES ENROLLMENT(ER_CODE)
,CONSTRAINT DO_DR_CODE_FK FOREIGN KEY(DR_CODE)
            REFERENCES DROP_REASON(DR_CODE)
, CONSTRAINT DO_ER_CODE_UK UNIQUE(ER_CODE)
);
--==>> Table DROP_OUT이(가) 생성되었습니다.


-- 테이블 생성
-- 테이블명: GRADE
CREATE TABLE GRADE
(
 GR_CODE    VARCHAR2(10)    CONSTRAINT GR_GR_CODE_NN NOT NULL
,ER_CODE    VARCHAR2(10)    CONSTRAINT GR_ER_CODE_NN NOT NULL   
,OS_CODE    VARCHAR2(10)    CONSTRAINT GR_OS_CODE_NN NOT NULL   
,ATT_SCORE  NUMBER(3)       CONSTRAINT GR_ATT_CK CHECK(ATT_SCORE BETWEEN 0 AND 100)
,WRT_SCORE  NUMBER(3)       CONSTRAINT GR_WRT_CK CHECK(WRT_SCORE BETWEEN 0 AND 100)
,PRC_SCORE  NUMBER(3)       CONSTRAINT GR_PRC_CK CHECK(PRC_SCORE BETWEEN 0 AND 100)    
,GR_DATE    DATE            DEFAULT SYSDATE CONSTRAINT GR_GR_DATE_NN NOT NULL
,CONSTRAINT GR_GR_CODE_PK PRIMARY KEY(GR_CODE)
,CONSTRAINT GR_ER_CODE_FK FOREIGN KEY(ER_CODE)
            REFERENCES ENROLLMENT(ER_CODE)
,CONSTRAINT GR_OS_CODE_FK FOREIGN KEY(OS_CODE)
            REFERENCES OPEN_SUB(OS_CODE)
,CONSTRAINT GR_ER_OS_CUK UNIQUE(ER_CODE,OS_CODE)
);
--==>>Table GRADE이(가) 생성되었습니다.

--------------------------------------------------------------------------------
-- 시퀀스 생성 실행 -------------------------------------------------------
-- 시퀀스 생성
-- 교수자 ID
CREATE SEQUENCE PROF_SEQ
START WITH 100
NOCACHE;

-- 개설 과정 코드
CREATE SEQUENCE OC_SEQ
START WITH 1
NOCACHE;

-- 수강신청 코드 
CREATE SEQUENCE ER_SEQ
START WITH 7
NOCACHE;


-- 관리자 ID
CREATE SEQUENCE SEQ_ADMIN
START WITH 100
NOCACHE;

-- 학생 ID 
CREATE SEQUENCE ST_SEQ
INCREMENT BY 1
START WITH 100
NOCACHE;

-- 관리자 개설과목 등록
CREATE SEQUENCE SEQ_OPEN_SUB
START WITH 1
NOCACHE;

-- 중도탈락 코드
CREATE SEQUENCE SEQ_DROPOUT
START WITH 3
NOCACHE;

-- 성적 코드
CREATE SEQUENCE GR_SEQ
INCREMENT BY 1
START WITH 1
NOCACHE;

-- 샘플데이터 모두 생성----------------------------------------------------

--○ 샘플 데이터
INSERT INTO PROF (PF_ID, PF_NAME, PF_SSN, PF_PW, PF_DATE) VALUES ('PF100', '강교수', '660222-1567422', '7654321', TO_DATE('2010-12-01', 'YYYY-MM-DD'));
INSERT INTO PROF (PF_ID, PF_NAME, PF_SSN, PF_PW, PF_DATE) VALUES ('PF101', '김교수', '700333-2933325', '1231234', TO_DATE('2011-01-26', 'YYYY-MM-DD'));

-- 2. STUD (학생)
INSERT INTO STUD (ST_ID, ST_PW, ST_NAME, ST_SSN, ST_DATE) VALUES ('ST111', '1234567', '홍길동', '770126-1234456', TO_DATE('2024-12-01', 'YYYY-MM-DD'));
INSERT INTO STUD (ST_ID, ST_PW, ST_NAME, ST_SSN, ST_DATE) VALUES ('ST112', '2345671', '고윤정', '971208-2345671', TO_DATE('2023-11-08', 'YYYY-MM-DD'));
INSERT INTO STUD (ST_ID, ST_PW, ST_NAME, ST_SSN, ST_DATE) VALUES ('ST113', '3456781', '이선호', '000904-3123456', TO_DATE('2022-11-09', 'YYYY-MM-DD'));

-- 3. COURSE (과정명)
INSERT INTO COURSE (CR_CODE, CR_NAME) VALUES ('CR001', '자바 풀스택');
INSERT INTO COURSE (CR_CODE, CR_NAME) VALUES ('CR002', '프론트엔드');


-- 4. SUB (과목명)
INSERT INTO SUB (SUB_CODE, SUB_NAME) VALUES ('SUB001', '자바');
INSERT INTO SUB (SUB_CODE, SUB_NAME) VALUES ('SUB002', 'SQL');

-- 5. TEXTBOOK (교재)
INSERT INTO TEXTBOOK (TB_CODE, TB_NAME) VALUES ('TB001', '스프링 인 액션');
INSERT INTO TEXTBOOK (TB_CODE, TB_NAME) VALUES ('TB002', '웹 프로그래밍 입문');
INSERT INTO TEXTBOOK (TB_CODE, TB_NAME) VALUES ('TB003', '데이터베이스 입문');
INSERT INTO TEXTBOOK (TB_CODE, TB_NAME) VALUES ('TB004', 'VUE.JS 3');

-- 6. CLASS (강의실)
INSERT INTO CLASS (CL_CODE, CL_NAME) VALUES ('CL001', 'A강의실');
INSERT INTO CLASS (CL_CODE, CL_NAME) VALUES ('CL002', 'B강의실');


-- 7. ADMIN_ROLE (관리자권한)
INSERT INTO ADMIN_ROLE (AR_CODE, AR_NAME) VALUES ('AR001', '최고관리자');
INSERT INTO ADMIN_ROLE (AR_CODE, AR_NAME) VALUES ('AR002', '일반관리자');

-- 8. DROP_REASON (탈락사유)
INSERT INTO DROP_REASON (DR_CODE, DR_REASON) VALUES ('DR001', '개인사정');
INSERT INTO DROP_REASON (DR_CODE, DR_REASON) VALUES ('DR002', '건강악화');
INSERT INTO DROP_REASON (DR_CODE, DR_REASON) VALUES ('DR003', '무단결석');

-- 9. ADMIN (관리자: AR_CODE 참조)
INSERT INTO ADMIN (AD_ID, AD_PW, AD_NAME, AD_SSN, AD_DATE, AR_CODE) 
VALUES ('AD100', '1122333', '김종서', '751010-1122333', TO_DATE('2012-01-26', 'YYYY-MM-DD'), 'AR002');
INSERT INTO ADMIN (AD_ID, AD_PW, AD_NAME, AD_SSN, AD_DATE, AR_CODE) 
VALUES ('AD101', '2777777', '조미숙', '790102-2777777', TO_DATE('2007-12-13', 'YYYY-MM-DD'), 'AR001');
INSERT INTO ADMIN (AD_ID, AD_PW, AD_NAME, AD_SSN, AD_DATE, AR_CODE) 
VALUES ('AD102', '1552147', '이기자', '890810-1552147', TO_DATE('2010-05-14', 'YYYY-MM-DD'), 'AR002');

-- 10. OPEN_COURSE (개설과정: CR_CODE, CL_CODE 참조)
INSERT INTO OPEN_COURSE (OC_CODE, CR_CODE, OC_SDATE, OC_EDATE, CL_CODE, OC_DATE) 
VALUES ('OC001', 'CR001', TO_DATE('2025-11-17', 'YYYY-MM-DD'), TO_DATE('2026-06-15', 'YYYY-MM-DD'), 'CL002', TO_DATE('2025-10-10', 'YYYY-MM-DD'));
INSERT INTO OPEN_COURSE (OC_CODE, CR_CODE, OC_SDATE, OC_EDATE, CL_CODE, OC_DATE) 
VALUES ('OC002', 'CR002', TO_DATE('2026-01-05', 'YYYY-MM-DD'), TO_DATE('2026-06-29', 'YYYY-MM-DD'), 'CL001', TO_DATE('2025-12-15', 'YYYY-MM-DD'));

-- 11. OPEN_SUB (개설과목: OC_CODE, PF_ID, SUB_CODE, TB_CODE 참조)
-- 배점(WEIGHT) 합계 및 CHECK 제약조건 준수
INSERT INTO OPEN_SUB (OS_CODE, OC_CODE, PF_ID, SUB_CODE, OS_SDATE, OS_EDATE, TB_CODE, ATT_WEIGHT, WRT_WEIGHT, PRC_WEIGHT, OS_DATE) 
VALUES ('OS001', 'OC001', 'PF101', 'SUB001', TO_DATE('2025-11-17', 'YYYY-MM-DD'), TO_DATE('2026-02-25', 'YYYY-MM-DD'), 'TB001', 20, 30, 50, TO_DATE('2025-10-10', 'YYYY-MM-DD'));
INSERT INTO OPEN_SUB (OS_CODE, OC_CODE, PF_ID, SUB_CODE, OS_SDATE, OS_EDATE, TB_CODE, ATT_WEIGHT, WRT_WEIGHT, PRC_WEIGHT, OS_DATE) 
VALUES ('OS002', 'OC001', 'PF100', 'SUB002', TO_DATE('2026-02-26', 'YYYY-MM-DD'), TO_DATE('2026-04-15', 'YYYY-MM-DD'), 'TB002', 20, 50, 30, TO_DATE('2025-10-10', 'YYYY-MM-DD'));
INSERT INTO OPEN_SUB (OS_CODE, OC_CODE, PF_ID, SUB_CODE, OS_SDATE, OS_EDATE, TB_CODE, ATT_WEIGHT, WRT_WEIGHT, PRC_WEIGHT, OS_DATE) 
VALUES ('OS003', 'OC002', 'PF100', 'SUB001', TO_DATE('2026-01-05', 'YYYY-MM-DD'), TO_DATE('2026-03-28', 'YYYY-MM-DD'), 'TB002', 30, 30, 40, TO_DATE('2025-12-15', 'YYYY-MM-DD'));
INSERT INTO OPEN_SUB (OS_CODE, OC_CODE, PF_ID, SUB_CODE, OS_SDATE, OS_EDATE, TB_CODE, ATT_WEIGHT, WRT_WEIGHT, PRC_WEIGHT, OS_DATE) 
VALUES ('OS004', 'OC002', 'PF101', 'SUB002', TO_DATE('2026-04-01', 'YYYY-MM-DD'), TO_DATE('2026-06-29', 'YYYY-MM-DD'), 'TB003', NULL, NULL, NULL, TO_DATE('2025-12-16', 'YYYY-MM-DD'));


-- 12. ENROLLMENT (수강신청: OC_CODE, ST_ID 참조)
INSERT INTO ENROLLMENT (ER_CODE, OC_CODE, ST_ID, ER_DATE) VALUES ('ER001', 'OC001', 'ST111', TO_DATE('2025-09-28', 'YYYY-MM-DD'));
INSERT INTO ENROLLMENT (ER_CODE, OC_CODE, ST_ID, ER_DATE) VALUES ('ER002', 'OC002', 'ST112', TO_DATE('2025-10-20', 'YYYY-MM-DD'));
INSERT INTO ENROLLMENT (ER_CODE, OC_CODE, ST_ID, ER_DATE) VALUES ('ER003', 'OC002', 'ST113', TO_DATE('2025-12-29', 'YYYY-MM-DD'));

-- 13. DROP_OUT (중도탈락: ER_CODE, DR_CODE 참조)
INSERT INTO DROP_OUT (DO_CODE, ER_CODE, DO_DATE, DR_CODE) 
VALUES ('DO001', 'ER001', TO_DATE('2025-12-11', 'YYYY-MM-DD'), 'DR001');
INSERT INTO DROP_OUT (DO_CODE, ER_CODE, DO_DATE, DR_CODE) 
VALUES ('DO002', 'ER002', TO_DATE('2026-06-27', 'YYYY-MM-DD'), 'DR002');

-- 14. GRADE (성적: ER_CODE, OS_CODE 참조)
INSERT INTO GRADE (GR_CODE, ER_CODE, OS_CODE, ATT_SCORE, WRT_SCORE, PRC_SCORE, GR_DATE) 
VALUES ('GR001', 'ER002', 'OS003', 80, 70, 60, TO_DATE('2026-03-20', 'YYYY-MM-DD'));
INSERT INTO GRADE (GR_CODE, ER_CODE, OS_CODE, ATT_SCORE, WRT_SCORE, PRC_SCORE, GR_DATE) 
VALUES ('GR002', 'ER002', 'OS004', 75, 57, 45, TO_DATE('2026-06-26', 'YYYY-MM-DD'));


--------------------------------------------------------------------------------
-- 프로시저/함수 모두 컴파일 실행 ---------------------------------------------- 
-- 관리자 로그인
CREATE OR REPLACE PROCEDURE PRC_AD_LOGIN
(
     P_AD_ID IN ADMIN.AD_ID%TYPE
    ,P_AD_PW IN ADMIN.AD_PW%TYPE
    
    ,P_AD_NAME OUT ADMIN.AD_NAME%TYPE
    ,P_RESULT OUT VARCHAR2
)
IS
    V_ID_MATCH NUMBER;
    V_PW_MATCH NUMBER;
BEGIN
    -- 1. 아이디 존재 여부 확인
    SELECT COUNT(*) INTO V_ID_MATCH
    FROM ADMIN
    WHERE AD_ID = P_AD_ID;
    
    -- 아이디가 존재하지 않는 경우
    IF V_ID_MATCH = 0 THEN
        P_RESULT := 'ID_NOT_FOUND';
        P_AD_NAME := NULL;
        RETURN;
    END IF;
    
    -- 2. 비밀번호 일치 여부 확인
    SELECT COUNT(*) INTO V_PW_MATCH
    FROM ADMIN
    WHERE AD_ID = P_AD_ID AND AD_PW = P_AD_PW;
    
    -- 비밀번호가 틀린 경우
    IF V_PW_MATCH = 0 THEN
        P_RESULT := 'WRONG_PASSWORD';
        P_AD_NAME := NULL;
        RETURN;
    END IF;
    
    -- 3. 로그인 성공
    SELECT AD_NAME INTO P_AD_NAME
    FROM ADMIN
    WHERE AD_ID = P_AD_ID AND AD_PW = P_AD_PW;
    
    P_RESULT := P_AD_ID;  -- 성공 시 아이디 반환
    
EXCEPTION
    WHEN OTHERS THEN
        P_RESULT := 'ERROR';
        P_AD_NAME := NULL;
END;


-- 교수자 로그인
CREATE OR REPLACE PROCEDURE PRC_PF_LOGIN
(
     P_PF_ID IN PROF.PF_ID%TYPE
    ,P_PF_PW IN PROF.PF_PW%TYPE
    ,P_PF_NAME OUT PROF.PF_NAME%TYPE 
    ,P_RESULT OUT VARCHAR2
)
IS
    V_ID_MATCH NUMBER;
    V_PW_MATCH NUMBER;
BEGIN
    
    SELECT COUNT(*) INTO V_ID_MATCH
    FROM PROF
    WHERE PF_ID = P_PF_ID;
   
   -- 아이디가 존재하지 않는 경우
    IF V_ID_MATCH = 0 THEN
        P_RESULT := 'ID_NOT_FOUND';
        P_PF_NAME := NULL;
        RETURN;
    END IF;
    
    -- 2. 비밀번호 일치 여부 확인
    SELECT COUNT(*) INTO V_PW_MATCH
    FROM PROF
    WHERE PF_ID = P_PF_ID AND PF_PW = P_PF_PW;
    
    -- 비밀번호가 틀린 경우
    IF V_PW_MATCH = 0 THEN
        P_RESULT := 'WRONG_PASSWORD';
        P_PF_NAME := NULL;
        RETURN;
    END IF;
    
    -- 3. 로그인 성공
    SELECT PF_NAME INTO P_PF_NAME
    FROM PROF
    WHERE PF_ID = P_PF_ID AND PF_PW = P_PF_PW;
    
    P_RESULT := P_PF_ID;  -- 성공 시 아이디 반환
    
EXCEPTION
    WHEN OTHERS THEN
        P_RESULT := 'ERROR';
        P_PF_NAME := NULL;
END;

-- 학생 로그인
CREATE OR REPLACE PROCEDURE PRC_ST_LOGIN
(
     P_ST_ID IN STUD.ST_ID%TYPE
    ,P_ST_PW IN STUD.ST_PW%TYPE
    ,P_ST_NAME OUT STUD.ST_NAME%TYPE
    ,P_RESULT OUT VARCHAR2
)
IS
    V_ID_MATCH NUMBER;
    V_PW_MATCH NUMBER;
BEGIN
    
    SELECT COUNT(*) INTO V_ID_MATCH
    FROM STUD
    WHERE ST_ID = P_ST_ID;
   
   -- 아이디가 존재하지 않는 경우
    IF V_ID_MATCH = 0 THEN
        P_RESULT := 'ID_NOT_FOUND';
        P_ST_NAME := NULL;
        RETURN;
    END IF;
    
    -- 2. 비밀번호 일치 여부 확인
    SELECT COUNT(*) INTO V_PW_MATCH
    FROM STUD
    WHERE ST_ID = P_ST_ID AND ST_PW = P_ST_PW;
    
    -- 비밀번호가 틀린 경우
    IF V_PW_MATCH = 0 THEN
        P_RESULT := 'WRONG_PASSWORD';
        P_ST_NAME := NULL;
        RETURN;
    END IF;
    
    -- 3. 로그인 성공
    SELECT ST_NAME INTO P_ST_NAME
    FROM STUD
    WHERE ST_ID = P_ST_ID AND ST_PW = P_ST_PW;
    
    P_RESULT := P_ST_ID;  -- 성공 시 아이디 반환
    
    EXCEPTION
        WHEN OTHERS THEN
            P_RESULT := 'ERROR';
            P_ST_NAME := NULL;
END;

-- 최종관리자 (관리자 역할) CUD
CREATE OR REPLACE PROCEDURE PRC_AR_CUD
(
     P_MODE IN VARCHAR2
    ,P_AR_CODE IN ADMIN_ROLE.AR_CODE%TYPE
    ,P_AR_NAME IN ADMIN_ROLE.AR_NAME%TYPE DEFAULT NULL
)
IS
    V_AR_CNT            NUMBER;
BEGIN
    
    IF P_MODE = 'C' THEN
        SELECT COUNT(*) INTO V_AR_CNT
        FROM ADMIN_ROLE
        WHERE AR_NAME = P_AR_NAME;

        IF V_AR_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20001, '중복이 존재합니다.');
        END IF;
        
        INSERT INTO ADMIN_ROLE (AR_CODE, AR_NAME)
        VALUES (P_AR_CODE, P_AR_NAME);

    ELSIF P_MODE = 'U' THEN
        -- 변경하려는 이름이 다른 코드에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_AR_CNT
        FROM ADMIN_ROLE
        WHERE AR_NAME = P_AR_NAME AND AR_CODE <> P_AR_CODE;

        IF V_AR_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20002, '이미 사용 중인 이름입니다.');
        END IF;
        
        UPDATE ADMIN_ROLE
        SET AR_NAME = P_AR_NAME
        WHERE AR_CODE = P_AR_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20004, '수정 대상이 존재하지 않습니다.');
        END IF;

    ELSIF P_MODE = 'D' THEN
        SELECT COUNT(*) INTO V_AR_CNT
        FROM ADMIN
        WHERE AR_CODE = P_AR_CODE;

        IF V_AR_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20003, '사용 중인 권한은 삭제할 수 없습니다.');
        END IF;

        DELETE FROM ADMIN_ROLE
        WHERE AR_CODE = P_AR_CODE;

        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20005, '삭제 대상이 존재하지 않습니다.');
        END IF;
    END IF;
    COMMIT;
END;

-- 관리자 (강의실명) CUD
CREATE OR REPLACE PROCEDURE PRC_CL_CUD
(
     P_MODE IN VARCHAR2
    ,P_CL_CODE IN CLASS.CL_CODE%TYPE
    ,P_CL_NAME IN CLASS.CL_NAME%TYPE DEFAULT NULL
)
IS
    V_CL_CNT            NUMBER;
BEGIN
    
    IF P_MODE = 'C' THEN
        SELECT COUNT(*) INTO V_CL_CNT
        FROM CLASS
        WHERE CL_NAME = P_CL_NAME;
        
        IF V_CL_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20001, '중복이 존재합니다.');
        END IF;
        
        INSERT INTO CLASS(CL_CODE, CL_NAME)
        VALUES (P_CL_CODE, P_CL_NAME);
    
    ELSIF P_MODE = 'U' THEN
        -- 변경하려는 이름이 다른 코드에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_CL_CNT
        FROM CLASS
        WHERE CL_NAME = P_CL_NAME AND CL_CODE <> P_CL_CODE;
        
        IF V_CL_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20002, '이미 사용 중인 이름입니다.');
        END IF;
        
        UPDATE CLASS
        SET CL_NAME = P_CL_NAME
        WHERE CL_CODE = P_CL_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20004, '수정 대상이 존재하지 않습니다.');
        END IF;
        
    ELSIF P_MODE = 'D' THEN
        -- 강의실이 개설과정에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_CL_CNT
        FROM OPEN_COURSE
        WHERE CL_CODE = P_CL_CODE;

        IF V_CL_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20003, '사용 중인 강의실은 삭제할 수 없습니다.');
        END IF;
        
        DELETE FROM CLASS
        WHERE CL_CODE = P_CL_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20005, '삭제 대상이 존재하지 않습니다.');
        END IF;
    END IF;
    COMMIT;
END;


-- 관리자 (과목명) CUD
CREATE OR REPLACE PROCEDURE PRC_SUB_CUD
(
     P_MODE IN VARCHAR2
    ,P_SUB_CODE IN SUB.SUB_CODE%TYPE
    ,P_SUB_NAME IN SUB.SUB_NAME%TYPE 
)
IS
    V_SUB_CNT           NUMBER;
BEGIN
    
    IF P_MODE = 'C' THEN
        SELECT COUNT(*) INTO V_SUB_CNT
        FROM SUB
        WHERE SUB_NAME = P_SUB_NAME;
        
        IF V_SUB_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20001, '중복이 존재합니다.');
        END IF;
        
        INSERT INTO SUB(SUB_CODE, SUB_NAME)
        VALUES (P_SUB_CODE, P_SUB_NAME);
        
    ELSIF P_MODE = 'U' THEN
        -- 변경하려는 이름이 다른 코드에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_SUB_CNT
        FROM SUB
        WHERE SUB_NAME = P_SUB_NAME AND SUB_CODE <> P_SUB_CODE;
        
        IF V_SUB_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20002, '이미 사용 중인 이름입니다.');
        END IF;
        
        UPDATE SUB
        SET SUB_NAME = P_SUB_NAME
        WHERE SUB_CODE = P_SUB_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20004, '수정 대상이 존재하지 않습니다.');
        END IF;
        
    ELSIF P_MODE = 'D' THEN
        -- 과목이 개설과목에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_SUB_CNT
        FROM OPEN_SUB
        WHERE SUB_CODE = P_SUB_CODE;

        IF V_SUB_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20003, '사용 중인 과목은 삭제할 수 없습니다.');
        END IF;
        
        DELETE FROM SUB
        WHERE SUB_CODE = P_SUB_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20005, '삭제 대상이 존재하지 않습니다.');
        END IF;
    END IF;
    COMMIT;
END;


-- 관리자 (과정명) C
CREATE OR REPLACE PROCEDURE PRC_CR_C
(
    P_CR_CODE IN COURSE.CR_CODE%TYPE
    ,P_CR_NAME IN COURSE.CR_NAME%TYPE 
)
IS
    V_CR_CNT            NUMBER;
BEGIN
    
        SELECT COUNT(*) INTO V_CR_CNT
        FROM COURSE
        WHERE CR_NAME = P_CR_NAME;
        
        IF V_CR_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20001, '중복이 존재합니다.');
        END IF;
        
        INSERT INTO COURSE(CR_CODE, CR_NAME)
        VALUES (P_CR_CODE, P_CR_NAME);
    COMMIT;
END;


-- 관리자 (과정명) UD
CREATE OR REPLACE PROCEDURE PRC_CR_UD
(
     P_MODE IN VARCHAR2
    ,P_CR_CODE IN COURSE.CR_CODE%TYPE
    ,P_CR_NAME IN COURSE.CR_NAME%TYPE DEFAULT NULL
)
IS
    V_CR_CNT            NUMBER;
BEGIN
        
    IF P_MODE = 'U' THEN
        -- 변경하려는 이름이 다른 코드에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_CR_CNT
        FROM COURSE
        WHERE CR_NAME = P_CR_NAME AND CR_CODE <> P_CR_CODE;
        
        IF V_CR_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20002, '이미 사용 중인 이름입니다.');
        END IF;
        
        UPDATE COURSE
        SET CR_NAME = P_CR_NAME
        WHERE CR_CODE = P_CR_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20004, '수정 대상이 존재하지 않습니다.');
        END IF;
        
    ELSIF P_MODE = 'D' THEN
        -- 과정이 개설과정에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_CR_CNT
        FROM OPEN_COURSE
        WHERE CR_CODE = P_CR_CODE;

        IF V_CR_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20003, '사용 중인 과정은 삭제할 수 없습니다.');
        END IF;
        
        DELETE FROM COURSE
        WHERE CR_CODE = P_CR_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20005, '삭제 대상이 존재하지 않습니다.');
        END IF;
    END IF;
    COMMIT;
END;

-- 관리자 (탈락사유) CUD
CREATE OR REPLACE PROCEDURE PRC_DR_CUD
(
     P_MODE IN VARCHAR2
    ,P_DR_CODE IN DROP_REASON.DR_CODE%TYPE
    ,P_DR_REASON IN DROP_REASON.DR_REASON%TYPE DEFAULT NULL
)
IS
    V_DR_CNT            NUMBER;
BEGIN
    
    IF P_MODE = 'C' THEN
        SELECT COUNT(*) INTO V_DR_CNT
        FROM DROP_REASON
        WHERE DR_REASON = P_DR_REASON;
        
        IF V_DR_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20001, '중복이 존재합니다.');
        END IF;
        
        INSERT INTO DROP_REASON(DR_CODE, DR_REASON)
        VALUES (P_DR_CODE, P_DR_REASON);
        
    ELSIF P_MODE = 'U' THEN
        -- 변경하려는 사유가 다른 코드에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_DR_CNT
        FROM DROP_REASON
        WHERE DR_REASON = P_DR_REASON AND DR_CODE <> P_DR_CODE;
        
        IF V_DR_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20002, '이미 사용 중인 사유입니다.');
        END IF;
        
        UPDATE DROP_REASON
        SET DR_REASON = P_DR_REASON
        WHERE DR_CODE = P_DR_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20004, '수정 대상이 존재하지 않습니다.');
        END IF;
        
    ELSIF P_MODE = 'D' THEN
        -- 탈락코드가 중도탈락에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_DR_CNT
        FROM DROP_OUT
        WHERE DR_CODE = P_DR_CODE;

        IF V_DR_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20003, '사용 중인 탈락사유는 삭제할 수 없습니다.');
        END IF;
        
        DELETE FROM DROP_REASON
        WHERE DR_CODE = P_DR_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20005, '삭제 대상이 존재하지 않습니다.');
        END IF;
    END IF;
    COMMIT;
END;


-- 관리자 (교재명) CUD
CREATE OR REPLACE PROCEDURE PRC_TB_CUD
(
     P_MODE IN VARCHAR2
    ,P_TB_CODE IN TEXTBOOK.TB_CODE%TYPE
    ,P_TB_NAME IN TEXTBOOK.TB_NAME%TYPE DEFAULT NULL
)
IS
    V_TB_CNT            NUMBER;
BEGIN
    
    IF P_MODE = 'C' THEN
        SELECT COUNT(*) INTO V_TB_CNT
        FROM TEXTBOOK
        WHERE TB_NAME = P_TB_NAME;
        
        IF V_TB_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20001, '중복이 존재합니다.');
        END IF;
        
        INSERT INTO TEXTBOOK(TB_CODE, TB_NAME)
        VALUES (P_TB_CODE, P_TB_NAME);
        
    ELSIF P_MODE = 'U' THEN
        -- 변경하려는 이름이 다른 코드에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_TB_CNT
        FROM TEXTBOOK
        WHERE TB_NAME = P_TB_NAME AND TB_CODE <> P_TB_CODE;
        
        IF V_TB_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20002, '이미 사용 중인 이름입니다.');
        END IF;
        
        UPDATE TEXTBOOK
        SET TB_NAME = P_TB_NAME
        WHERE TB_CODE = P_TB_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20004, '수정 대상이 존재하지 않습니다.');
        END IF;
        
    ELSIF P_MODE = 'D' THEN
        -- 교재가 개설과목에서 사용 중인지 확인
        SELECT COUNT(*) INTO V_TB_CNT
        FROM OPEN_SUB
        WHERE TB_CODE = P_TB_CODE;

        IF V_TB_CNT > 0 THEN
            RAISE_APPLICATION_ERROR(-20003, '사용 중인 교재는 삭제할 수 없습니다.');
        END IF;
        
        DELETE FROM TEXTBOOK
        WHERE TB_CODE = P_TB_CODE;
        
        IF SQL%ROWCOUNT = 0 THEN
            RAISE_APPLICATION_ERROR(-20005, '삭제 대상이 존재하지 않습니다.');
        END IF;
    END IF;
    COMMIT;
END;



-- 관리자의 등급은 화면에 한글로 표기되어 선택
CREATE OR REPLACE PROCEDURE PRC_AD_C
(
 P_NAME  ADMIN.AD_NAME%TYPE
,P_SSN   ADMIN.AD_SSN%TYPE
,P_GRADE ADMIN_ROLE.AR_CODE%TYPE   
)
IS
    V_PW ADMIN.AD_PW%TYPE;
    V_SSN   NUMBER;
    USER_DEFINE_ERROR EXCEPTION;
BEGIN
    
    -- 주민번호 하이픈 위치 검증
    IF (SUBSTR(P_SSN,7,1) != '-') THEN
        RAISE USER_DEFINE_ERROR;
    END IF;
    -- 주민번호 앞뒤 숫자 검증
    V_SSN := TO_NUMBER(SUBSTR(P_SSN, 1, 6));
    V_SSN := TO_NUMBER(SUBSTR(P_SSN, 8, 7));
    
    
    V_PW := SUBSTR(P_SSN,8);
    
    INSERT INTO ADMIN(AD_ID,AD_PW,AD_NAME,AD_SSN,AR_CODE)
    VALUES ('AD'||LPAD(SEQ_ADMIN.NEXTVAL,3,'0'),V_PW,P_NAME,P_SSN,P_GRADE);
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_DEFINE_ERROR THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
        WHEN VALUE_ERROR THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
    
END;


--최종 관리자 수정
CREATE OR REPLACE PROCEDURE PRC_AD_U
(
 P_ID     ADMIN.AD_ID%TYPE
,P_NAME   ADMIN.AD_NAME%TYPE
,P_SSN    ADMIN.AD_SSN%TYPE
,P_PW     ADMIN.AD_PW%TYPE
,P_GRADE  ADMIN_ROLE.AR_CODE%TYPE   
)
IS
    V_GRADE ADMIN_ROLE.AR_CODE%TYPE;
    V_NUM NUMBER;
    V_SSN      NUMBER;
    USER_ERROR EXCEPTION; -- 역할별 한명만 남아있는 관리자를 변경하려할때
    USER_DEFINE_ERROR2 EXCEPTION;
BEGIN
    
     -- 주민번호 하이픈 위치 검증
    IF (SUBSTR(P_SSN,7,1) != '-') THEN
        RAISE USER_DEFINE_ERROR2;
    END IF;
    -- 주민번호 앞뒤 숫자 검증
    V_SSN := TO_NUMBER(SUBSTR(P_SSN, 1, 6));
    V_SSN := TO_NUMBER(SUBSTR(P_SSN, 8, 7));
    
    
    SELECT AR_CODE INTO V_GRADE
    FROM ADMIN
    WHERE AD_ID = P_ID;
    
    SELECT COUNT(*) INTO V_NUM
    FROM ADMIN
    WHERE AR_CODE = V_GRADE;
    
    IF V_NUM = 1 AND V_GRADE != P_GRADE
        THEN RAISE USER_ERROR;
    END IF;
    
    UPDATE ADMIN
    SET AD_NAME = NVL(P_NAME,AD_NAME), AD_SSN = NVL(P_SSN,AD_SSN), AD_PW =NVL(P_PW,AD_PW)
       ,AR_CODE = NVL(P_GRADE,AR_CODE)
    WHERE AD_ID = P_ID;
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_ERROR
            THEN RAISE_APPLICATION_ERROR(-20032,'등급별 최소 한명의 관리자가 필요합니다');
        WHEN USER_DEFINE_ERROR2 THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
        WHEN VALUE_ERROR THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
    
END;

-- 최종관리자 삭제
CREATE OR REPLACE PROCEDURE PRC_AD_D
(
P_ID ADMIN.AD_ID%TYPE
)
IS
    V_GRADE ADMIN_ROLE.AR_CODE%TYPE;
    V_NUM NUMBER;
    USER_ERROR EXCEPTION;   -- 역할별 한명만 남아있는 관리자를 삭제하려할때
BEGIN
    SELECT AR_CODE INTO V_GRADE
    FROM ADMIN
    WHERE AD_ID = P_ID;
    
    SELECT COUNT(*) INTO V_NUM
    FROM ADMIN
    WHERE AR_CODE = V_GRADE;
    
    IF (V_NUM = 1)
        THEN RAISE USER_ERROR;
    END IF;

    DELETE
    FROM ADMIN
    WHERE AD_ID = P_ID;
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_ERROR
            THEN RAISE_APPLICATION_ERROR(-20014,'등급별 최소 한명의 관리자가 필요합니다');

END;

-- 학생 생성
CREATE OR REPLACE PROCEDURE PRC_ST_C
( P_ST_NAME   IN  STUD.ST_NAME%TYPE
, P_ST_SSN    IN  STUD.ST_SSN%TYPE
)
IS
    V_SEQ   NUMBER;
    V_SSN   NUMBER;
    USER_DEFINE_ERROR EXCEPTION;
BEGIN
    -- 주민번호 하이픈 위치 검증
    IF (SUBSTR(P_ST_SSN,7,1) != '-') THEN
        RAISE USER_DEFINE_ERROR;
    END IF;
    -- 주민번호 앞뒤 숫자 검증
    V_SSN := TO_NUMBER(SUBSTR(P_ST_SSN, 1, 6));
    V_SSN := TO_NUMBER(SUBSTR(P_ST_SSN, 8, 7));
    
    SELECT ST_SEQ.NEXTVAL INTO V_SEQ
    FROM DUAL;
    INSERT INTO STUD(ST_ID, ST_PW, ST_NAME, ST_SSN)
    VALUES('ST'||V_SEQ, SUBSTR(P_ST_SSN,8),P_ST_NAME,P_ST_SSN);
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_DEFINE_ERROR THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
        WHEN VALUE_ERROR THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
    
END;

-- STUD테이블에 UPDATE - 관리자만 가능 (학생아이디, 이름, 주민번호, 비밀번호)
CREATE OR REPLACE PROCEDURE PRC_ST_U
( P_ST_ID   IN  STUD.ST_ID%TYPE
, P_ST_NAME IN  STUD.ST_NAME%TYPE
, P_ST_SSN  IN  STUD.ST_SSN%TYPE
, P_ST_PW   IN  STUD.ST_PW%TYPE
)
IS
    V_ST_CNT            NUMBER;
    V_SSN               NUMBER;
    USER_DEFINE_ERROR1  EXCEPTION;
    USER_DEFINE_ERROR2  EXCEPTION;
BEGIN
     -- 주민번호 하이픈 위치 검증
    IF (SUBSTR(P_ST_SSN,7,1) != '-') THEN
        RAISE USER_DEFINE_ERROR2;
    END IF;
    -- 주민번호 앞뒤 숫자 검증
    V_SSN := TO_NUMBER(SUBSTR(P_ST_SSN, 1, 6));
    V_SSN := TO_NUMBER(SUBSTR(P_ST_SSN, 8, 7));
    

    SELECT COUNT(*) INTO V_ST_CNT
    FROM STUD
    WHERE ST_ID = P_ST_ID;
    
    IF (V_ST_CNT = 0) THEN
        RAISE USER_DEFINE_ERROR1;
    END IF;
    

    UPDATE STUD
    SET ST_NAME = NVL(P_ST_NAME, ST_NAME), ST_SSN = NVL(P_ST_SSN, ST_SSN), ST_PW = NVL(P_ST_PW, ST_PW)
    WHERE ST_ID = P_ST_ID;
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_DEFINE_ERROR1 THEN    
            RAISE_APPLICATION_ERROR(-20006, '데이터가 존재하지 않습니다.');
            ROLLBACK;
        WHEN USER_DEFINE_ERROR2 THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
        WHEN VALUE_ERROR THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
END;



-- 프로시저명: PRC_ST_D
-- STUD테이블에 DELETE - 관리자만 가능 (학생아이디) 
-- 학생이 수강신청이나 성적에 없을 때만 삭제 가능
CREATE OR REPLACE PROCEDURE PRC_ST_D
(P_ST_ID IN STUD.ST_ID%TYPE)
IS
    USER_DEFINE_ERROR1   EXCEPTION;
    USER_DEFINE_ERROR2   EXCEPTION;
    V_EN_CNT            NUMBER;
    V_ST_CNT            NUMBER;
BEGIN
    
    SELECT COUNT(*) INTO V_ST_CNT
    FROM STUD
    WHERE ST_ID = P_ST_ID;
    
    IF (V_ST_CNT = 0) THEN
        RAISE USER_DEFINE_ERROR1;
    END IF;
    
    SELECT COUNT(*)  INTO V_EN_CNT
    FROM ENROLLMENT
    WHERE ST_ID = P_ST_ID;
    
    IF (V_EN_CNT > 0 ) THEN
        RAISE USER_DEFINE_ERROR2;
    ELSE
        DELETE
        FROM STUD
        WHERE ST_ID = P_ST_ID;
    END IF;
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_DEFINE_ERROR1 THEN    
            RAISE_APPLICATION_ERROR(-20006, '데이터가 존재하지 않습니다.');
            ROLLBACK;
        WHEN USER_DEFINE_ERROR2 THEN
            RAISE_APPLICATION_ERROR(-20007, '삭제 불가능합니다.');
            ROLLBACK;
END;


-- 교수자 생성
CREATE OR REPLACE PROCEDURE PRC_PF_C
(
  P_PF_NAME IN PROF.PF_NAME%TYPE,
  P_PF_SSN  IN PROF.PF_SSN%TYPE
)
IS
    V_SSN   NUMBER;
    USER_DEFINE_ERROR EXCEPTION;
BEGIN
    -- 주민번호 하이픈 위치 검증
    IF (SUBSTR(P_PF_SSN,7,1) != '-') THEN
        RAISE USER_DEFINE_ERROR;
    END IF;
    -- 주민번호 앞뒤 숫자 검증
    V_SSN := TO_NUMBER(SUBSTR(P_PF_SSN, 1, 6));
    V_SSN := TO_NUMBER(SUBSTR(P_PF_SSN, 8, 7));
    

    INSERT INTO PROF(PF_ID, PF_NAME, PF_SSN, PF_PW)
    VALUES('PF' || LPAD(PROF_SEQ.NEXTVAL, 3, '0'), P_PF_NAME, P_PF_SSN, SUBSTR(P_PF_SSN, 8));
    
    COMMIT;
    
    EXCEPTION
         WHEN USER_DEFINE_ERROR THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
        WHEN VALUE_ERROR THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
END;

-- 교수자 수정
CREATE OR REPLACE PROCEDURE PRC_PF_U
(
  P_PF_ID   IN PROF.PF_ID%TYPE,
  P_PF_PW   IN PROF.PF_PW%TYPE,
  P_PF_NAME IN PROF.PF_NAME%TYPE,
  P_PF_SSN  IN PROF.PF_SSN%TYPE
)
IS
  V_PFU_CNT NUMBER;
  V_PF_CNT  NUMBER;
  V_SSN     NUMBER;
  USER_DEFINE_ERROR EXCEPTION;
BEGIN

    

    -- 수정 대상 존재 확인
    SELECT COUNT(*) INTO V_PF_CNT
    FROM PROF
    WHERE PF_ID = P_PF_ID;
    
    IF V_PF_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20006, '데이터가 존재하지 않습니다.');
    END IF;
    
    -- 주민번호 하이픈 위치 검증
    IF (SUBSTR(P_PF_SSN,7,1) != '-') THEN
        RAISE USER_DEFINE_ERROR;
    END IF;
    -- 주민번호 앞뒤 숫자 검증
    V_SSN := TO_NUMBER(SUBSTR(P_PF_SSN, 1, 6));
    V_SSN := TO_NUMBER(SUBSTR(P_PF_SSN, 8, 7));

    -- 주민번호 중복 확인 (자기 자신 제외)
    SELECT COUNT(*) INTO V_PFU_CNT
    FROM PROF
    WHERE PF_SSN = P_PF_SSN
      AND PF_ID != P_PF_ID;

    IF V_PFU_CNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20014, '이미 사용 중인 주민번호입니다.');
    END IF;  
       
    UPDATE PROF
    SET  PF_PW = NVL(P_PF_PW,PF_PW)
        ,PF_NAME = NVL(P_PF_NAME,PF_NAME)
        ,PF_SSN = NVL(P_PF_SSN,PF_SSN)
    WHERE PF_ID = P_PF_ID;
    
    COMMIT;
    
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20008, '수정 대상이 존재하지 않습니다.');
    END IF;
    
    EXCEPTION
         WHEN USER_DEFINE_ERROR THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
        WHEN VALUE_ERROR THEN
            RAISE_APPLICATION_ERROR(-20050, '주민등록번호 형식을 잘못 입력했습니다.');
            ROLLBACK;
END;

-- 교수자 삭제
CREATE OR REPLACE PROCEDURE PRC_PF_D
(
  P_PF_ID IN PROF.PF_ID%TYPE
)
IS
    V_PF_CNT  NUMBER;
    V_SUB_CNT NUMBER;
BEGIN
    -- 교수 존재 확인
    SELECT COUNT(*) INTO V_PF_CNT 
    FROM PROF 
    WHERE PF_ID = P_PF_ID;
    
    IF V_PF_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20006, '데이터가 존재하지 않습니다.');
    END IF;
    
    -- 담당 개설과목 확인
    SELECT COUNT(*) INTO V_SUB_CNT 
    FROM OPEN_SUB 
    WHERE PF_ID = P_PF_ID;
    
    IF V_SUB_CNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20015, '담당 중인 개설과목이 존재하여 삭제할 수 없습니다.');
    END IF;
    
    DELETE FROM PROF
    WHERE PF_ID = P_PF_ID;
    
    COMMIT;
    
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20006, '삭제 대상이 존재하지 않습니다.');
    END IF;
END;

-- 개설과정 생성
CREATE OR REPLACE PROCEDURE PRC_OC_C
(
  P_CR_CODE  IN OPEN_COURSE.CR_CODE%TYPE,
  P_OC_SDATE IN OPEN_COURSE.OC_SDATE%TYPE,
  P_OC_EDATE IN OPEN_COURSE.OC_EDATE%TYPE,
  P_CL_CODE  IN OPEN_COURSE.CL_CODE%TYPE
)
IS
    V_CR_CNT   NUMBER;
    V_ROOM_CNT NUMBER;
BEGIN
    -- 날짜 유효성 체크
    IF P_OC_EDATE < P_OC_SDATE THEN
        RAISE_APPLICATION_ERROR(-20016, '종료일이 시작일보다 빠를 수 없습니다.');
    END IF;
    
    -- 과정코드 존재 확인
    SELECT COUNT(*) INTO V_CR_CNT
    FROM COURSE
    WHERE CR_CODE = P_CR_CODE;
    
    IF V_CR_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20017, '존재하지 않는 과정코드입니다.');
    END IF;
    
    -- 동일 과정 중복 개설 확인 (같은 날짜에 같은 과정)
    SELECT COUNT(*) INTO V_CR_CNT
    FROM OPEN_COURSE
    WHERE CR_CODE = P_CR_CODE
      AND OC_SDATE = P_OC_SDATE;
    
    IF V_CR_CNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20018, '해당 날짜에 이미 동일한 과정이 개설되어 있습니다.');
    END IF;
    
    -- 강의실 중복 사용 확인 (같은 기간에 같은 강의실)
    SELECT COUNT(*) INTO V_ROOM_CNT
    FROM OPEN_COURSE
    WHERE CL_CODE = P_CL_CODE
      AND (
          (P_OC_SDATE BETWEEN OC_SDATE AND OC_EDATE) OR
          (P_OC_EDATE BETWEEN OC_SDATE AND OC_EDATE) OR
          (OC_SDATE BETWEEN P_OC_SDATE AND P_OC_EDATE)
      );
    
    IF V_ROOM_CNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20004, '해당 기간에 강의실이 이미 사용 중입니다.');
    END IF;

    INSERT INTO OPEN_COURSE(OC_CODE, CR_CODE, OC_SDATE, OC_EDATE, CL_CODE)
    VALUES('OC' || LPAD(OC_SEQ.NEXTVAL, 3, '0'), P_CR_CODE, P_OC_SDATE, P_OC_EDATE, P_CL_CODE);
    
    COMMIT;
    
END;

-- 개설과정 수정
CREATE OR REPLACE PROCEDURE PRC_OC_U
(
  P_OC_CODE  IN OPEN_COURSE.OC_CODE%TYPE,
  P_CR_CODE  IN OPEN_COURSE.CR_CODE%TYPE,
  P_OC_SDATE IN OPEN_COURSE.OC_SDATE%TYPE,
  P_OC_EDATE IN OPEN_COURSE.OC_EDATE%TYPE,
  P_CL_CODE  IN OPEN_COURSE.CL_CODE%TYPE
)
IS
  V_OC_CNT     NUMBER;
  V_ROOM_CNT   NUMBER;
  V_CR_CNT     NUMBER;
BEGIN
    -- 날짜 유효성 체크
    IF P_OC_EDATE < P_OC_SDATE THEN
        RAISE_APPLICATION_ERROR(-20016, '종료일이 시작일보다 빠를 수 없습니다.');
    END IF;
    
    -- 수정 대상 존재 확인
    SELECT COUNT(*) INTO V_OC_CNT
    FROM OPEN_COURSE
    WHERE OC_CODE = P_OC_CODE;
    
    IF V_OC_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20020, '수정할 개설과정이 존재하지 않습니다.');
    END IF;
    
    -- 과정코드 존재 확인
    SELECT COUNT(*) INTO V_CR_CNT
    FROM COURSE
    WHERE CR_CODE = P_CR_CODE;
    
    IF V_CR_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20017, '존재하지 않는 과정코드입니다.');
    END IF;
    
    -- 중복 과정 확인 (자기 자신 제외)
    SELECT COUNT(*) INTO V_OC_CNT
    FROM OPEN_COURSE
    WHERE CR_CODE = P_CR_CODE
      AND OC_SDATE = P_OC_SDATE
      AND OC_CODE = P_OC_CODE;

    IF V_OC_CNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20021, '이미 동일한 개설과정이 존재합니다.');
    END IF;
    
    -- 강의실 중복 확인 (기간 겹침, 자기 자신 제외)
    SELECT COUNT(*) INTO V_ROOM_CNT
    FROM OPEN_COURSE
    WHERE CL_CODE = P_CL_CODE
      AND OC_CODE != P_OC_CODE
      AND (
          (P_OC_SDATE BETWEEN OC_SDATE AND OC_EDATE) OR
          (P_OC_EDATE BETWEEN OC_SDATE AND OC_EDATE) OR
          (OC_SDATE BETWEEN P_OC_SDATE AND P_OC_EDATE)
      );

    IF V_ROOM_CNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20019, '해당 기간에 강의실이 이미 사용 중입니다.');
    END IF;
           
    UPDATE OPEN_COURSE
    SET  CR_CODE = NVL(P_CR_CODE,CR_CODE)
        ,OC_SDATE = NVL(P_OC_SDATE,OC_SDATE)
        ,OC_EDATE = NVL(P_OC_EDATE,OC_EDATE)
        ,CL_CODE = NVL(P_CL_CODE,CL_CODE)
    WHERE OC_CODE = P_OC_CODE;
    
    COMMIT;
    
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20008, '수정 대상이 존재하지 않습니다.');
    END IF;
END;

-- 개설과정 삭제
CREATE OR REPLACE PROCEDURE PRC_OC_D
(
  P_OC_CODE IN OPEN_COURSE.OC_CODE%TYPE
)
IS
    V_OC_CNT     NUMBER;
    V_SUB_CNT    NUMBER;
    V_ENROLL_CNT NUMBER;
BEGIN
    -- 개설과정 존재 확인
    SELECT COUNT(*) INTO V_OC_CNT
    FROM OPEN_COURSE
    WHERE OC_CODE = P_OC_CODE;
    
    IF V_OC_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20012, '존재하지 않는 개설과정입니다.');
    END IF;
    
    -- 개설과목 존재 확인
    SELECT COUNT(*) INTO V_SUB_CNT
    FROM OPEN_SUB
    WHERE OC_CODE = P_OC_CODE;

    -- 수강신청 존재 확인
    SELECT COUNT(*) INTO V_ENROLL_CNT
    FROM ENROLLMENT
    WHERE OC_CODE = P_OC_CODE;

    -- 자식 데이터 존재 시 삭제 불가
    IF V_SUB_CNT > 0 OR V_ENROLL_CNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20022, '개설과목 또는 수강신청 데이터가 존재하여 삭제할 수 없습니다.');
    END IF;
    
    DELETE FROM OPEN_COURSE
    WHERE OC_CODE = P_OC_CODE;
    
    COMMIT;
    
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20005, '삭제 대상이 존재하지 않습니다.');
    END IF;
END;

-- 함수
-- 개설과목

-- 포함된 개설과정내에 맞는 일시를 입력했는지 확인하는 함수
--(개설과정코드,시작일시,종료일시)
-- 1실패 0성공 함수
CREATE OR REPLACE FUNCTION FN_OS_D 
(
 P_OCCODE   OPEN_SUB.OC_CODE%TYPE
,P_START    OPEN_SUB.OS_SDATE%TYPE
,P_END      OPEN_SUB.OS_EDATE%TYPE
)
RETURN NUMBER
IS
    V_RESULT NUMBER := 0;
    V_START  OPEN_COURSE.OC_SDATE%TYPE;
    V_END    OPEN_COURSE.OC_EDATE%TYPE;
BEGIN
  
    SELECT OC_SDATE,OC_EDATE INTO V_START,V_END
    FROM OPEN_COURSE
    WHERE OC_CODE = P_OCCODE;

    IF (V_START > P_START OR V_END < P_END) OR P_START > P_END
        THEN V_RESULT := 1;
    END IF;
    RETURN V_RESULT;
END;

-- 중복체크 
-- 과정별 교육일 중복 확인 함수
-- (개설과정코드,시작일시,종료일시)
-- 1실패 0성공 함수
-- INSERT 용
CREATE OR REPLACE FUNCTION FN_OS_J1
(
 P_OCCODE   OPEN_SUB.OC_CODE%TYPE
,P_START    OPEN_SUB.OS_SDATE%TYPE
,P_END      OPEN_SUB.OS_EDATE%TYPE
)
RETURN NUMBER
IS
    CURSOR CUR_OS
    IS
    SELECT OS_SDATE,OS_EDATE
    FROM OPEN_SUB
    WHERE OC_CODE = P_OCCODE;
    V_RESULT NUMBER := 0;
BEGIN
    FOR REC IN CUR_OS LOOP
        IF (P_START <= REC.OS_EDATE AND P_END >= REC.OS_SDATE)
            THEN V_RESULT := 1;
            EXIT;
        END IF;
    END LOOP;
    RETURN V_RESULT;
END;
-- UPDATE 용
CREATE OR REPLACE FUNCTION FN_OS_J2
(
 P_OSCODE   OPEN_SUB.OC_CODE%TYPE
,P_OCCODE   OPEN_SUB.OC_CODE%TYPE
,P_START    OPEN_SUB.OS_SDATE%TYPE
,P_END      OPEN_SUB.OS_EDATE%TYPE
)
RETURN NUMBER
IS
    CURSOR CUR_OS
    IS
    SELECT OS_SDATE,OS_EDATE
    FROM OPEN_SUB
    WHERE OC_CODE = P_OCCODE
    AND NOT OS_CODE = P_OSCODE;
    V_RESULT NUMBER := 0;
BEGIN
    FOR REC IN CUR_OS LOOP
        IF (P_START <= REC.OS_EDATE AND P_END >= REC.OS_SDATE)
            THEN V_RESULT := 1;
            EXIT;
        END IF;
    END LOOP;
    RETURN V_RESULT;
END;

-- 교수의 강의 일자 중복 확인 함수
-- (교수아이디,시작일시,종료일시)
-- 1실패 0성공 함수
-- INSERT 용
CREATE OR REPLACE FUNCTION FN_OS_G1
(
 P_PFID     OPEN_SUB.PF_ID%TYPE
,P_START    OPEN_SUB.OS_SDATE%TYPE
,P_END      OPEN_SUB.OS_EDATE%TYPE
)
RETURN NUMBER
IS
    CURSOR CUR_OSS
    IS
    SELECT OS_SDATE,OS_EDATE
    FROM OPEN_SUB
    WHERE PF_ID = P_PFID;
    V_RESULT NUMBER := 0;
BEGIN
    FOR REC IN CUR_OSS LOOP
        IF (P_START <= REC.OS_EDATE AND P_END >= REC.OS_SDATE)
            THEN V_RESULT := 1;
            EXIT;
        END IF;
    END LOOP;
    RETURN V_RESULT;
END;

-- UPDATE 용
CREATE OR REPLACE FUNCTION FN_OS_G2
(
 P_OSCODE   OPEN_SUB.OC_CODE%TYPE
,P_PFID     OPEN_SUB.PF_ID%TYPE
,P_START    OPEN_SUB.OS_SDATE%TYPE
,P_END      OPEN_SUB.OS_EDATE%TYPE
)
RETURN NUMBER
IS
    CURSOR CUR_OSS
    IS
    SELECT OS_SDATE,OS_EDATE
    FROM OPEN_SUB
    WHERE PF_ID = P_PFID
    AND NOT OS_CODE = P_OSCODE;
    V_RESULT NUMBER := 0;
BEGIN
    FOR REC IN CUR_OSS LOOP
        IF (P_START <= REC.OS_EDATE AND P_END >= REC.OS_SDATE)
            THEN V_RESULT := 1;
            EXIT;
        END IF;
    END LOOP;
    RETURN V_RESULT;
END;

-- 과목 생성
CREATE OR REPLACE PROCEDURE PRC_OS_C -- 배점 안받는 상태
(
 P_OCCODE   OPEN_SUB.OC_CODE%TYPE
,P_PFID     OPEN_SUB.PF_ID%TYPE
,P_SUBCODE  OPEN_SUB.SUB_CODE%TYPE  
,P_START    OPEN_SUB.OS_SDATE%TYPE
,P_END      OPEN_SUB.OS_EDATE%TYPE
,P_TBCODE   OPEN_SUB.TB_CODE%TYPE 
)
IS
    USER_ERROR1 EXCEPTION; -- 과정내 포함되는 기간이아니면 에러
    USER_ERROR2 EXCEPTION; -- 과목 일시가 중복 되면 에러
    USER_ERROR3 EXCEPTION; -- 교수 일정이 중복되면에러
BEGIN
    
    -- 상의 개설강의내 포함 일자인지 확인
    IF FN_OS_D(P_OCCODE,P_START,P_END) = 1
        THEN RAISE USER_ERROR1;
    -- 과목 일정 중복 확인
    ELSIF FN_OS_J1(P_OCCODE,P_START,P_END) = 1
        THEN RAISE USER_ERROR2;
    --교수자 중복 확인
    ELSIF FN_OS_G1(P_PFID,P_START,P_END) = 1
        THEN RAISE USER_ERROR3;
    END IF;
    
    INSERT INTO OPEN_SUB(OS_CODE,OC_CODE,SUB_CODE,PF_ID,OS_SDATE
                         ,OS_EDATE,TB_CODE)
    VALUES('OS'|| LPAD(SEQ_OPEN_SUB.NEXTVAL,3,'0'),P_OCCODE,P_SUBCODE
          ,P_PFID,P_START,P_END,P_TBCODE);
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_ERROR1
            THEN RAISE_APPLICATION_ERROR(-20033,'개설과정내 일시를 입력해주세요');
        WHEN USER_ERROR2
            THEN RAISE_APPLICATION_ERROR(-20034,'기존 등록된 과목과 강의 일자가 겹칠수 없습니다');
        WHEN USER_ERROR3
            THEN RAISE_APPLICATION_ERROR(-20035,'교수자는 한개의 강의만 가능합니다');
END;

-- 관리자 개설과목 수정
CREATE OR REPLACE PROCEDURE PRC_OS_U
(
 P_OSCODE   OPEN_SUB.OS_CODE%TYPE
,P_OCCODE   OPEN_SUB.OC_CODE%TYPE
,P_SUBCODE  OPEN_SUB.SUB_CODE%TYPE
,P_PFID     OPEN_SUB.PF_ID%TYPE
,P_START    OPEN_SUB.OS_SDATE%TYPE
,P_END      OPEN_SUB.OS_EDATE%TYPE
,P_TBCODE   OPEN_SUB.TB_CODE%TYPE
)
IS
    USER_ERROR1 EXCEPTION; -- 과정내 포함되는 기간이아니면 에러
    USER_ERROR2 EXCEPTION; -- 과목 일시가 중복 되면 에러
    USER_ERROR3 EXCEPTION; -- 교수 일정이 중복되면에러
BEGIN
        
    -- 상위 개설강의내 포함 일자인지 확인
    IF FN_OS_D(P_OCCODE,P_START,P_END) = 1
        THEN RAISE USER_ERROR1;
    -- 과목 일정 중복 확인
    ELSIF FN_OS_J2(P_OSCODE,P_OCCODE,P_START,P_END) = 1
        THEN RAISE USER_ERROR2;
    --교수자 중복 확인
    ELSIF FN_OS_G2(P_OSCODE,P_PFID,P_START,P_END) = 1
        THEN RAISE USER_ERROR3;
    END IF;

    UPDATE OPEN_SUB
    SET  OC_CODE = NVL(P_OCCODE,OC_CODE) 
        ,SUB_CODE = NVL(P_SUBCODE,SUB_CODE)
        , PF_ID = NVL(P_PFID,PF_ID)
        ,OS_SDATE = NVL(P_START,OS_SDATE)
        , OS_EDATE = NVL(P_END,OS_EDATE)
        , TB_CODE = NVL(P_TBCODE,TB_CODE)
    WHERE OS_CODE = P_OSCODE;
    
    COMMIT;
    
     EXCEPTION
        WHEN USER_ERROR1
            THEN RAISE_APPLICATION_ERROR(-20015,'개설과정내 일시를 입력해주세요');
        WHEN USER_ERROR2
            THEN RAISE_APPLICATION_ERROR(-20016,'기존 등록된 과목과 강의 일자가 겹칠수 없습니다');
        WHEN USER_ERROR3
            THEN RAISE_APPLICATION_ERROR(-20017,'교수자는 한개의 강의만 가능합니다');
END;

-- 관리자,교수 배점 등록
CREATE OR REPLACE PROCEDURE PRC_OS_UB
(
 P_OSCODE OPEN_SUB.OC_CODE%TYPE
,P_ATT  OPEN_SUB.ATT_WEIGHT%TYPE
,P_WRT  OPEN_SUB.WRT_WEIGHT%TYPE
,P_PRC  OPEN_SUB.PRC_WEIGHT%TYPE
)
IS
    USER_ERROR EXCEPTION;   -- 배점총합이 100이 아닌 경우 에러
BEGIN
    
    IF (P_ATT+P_WRT+P_PRC != 100)
        THEN RAISE USER_ERROR;
    END IF;
    
    UPDATE OPEN_SUB
    SET ATT_WEIGHT = NVL(P_ATT,ATT_WEIGHT)
       ,WRT_WEIGHT = NVL(P_WRT,WRT_WEIGHT)
       ,PRC_WEIGHT = NVL(P_PRC,PRC_WEIGHT)
    WHERE OS_CODE = P_OSCODE;
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_ERROR
            THEN RAISE_APPLICATION_ERROR(-20036,'배점의 배율이 100이 되지않아 입력할 수 없습니다');
                 
END;

-- 개설 과목 삭제
CREATE OR REPLACE PROCEDURE PRC_OS_D
(
P_OSCODE OPEN_SUB.OS_CODE%TYPE
)
IS
    USER_ERROR EXCEPTION;   -- 삭제하려는 개설과목이 이미 시작됐으면 에러
    V_OCCODE OPEN_COURSE.OC_CODE%TYPE;
    V_DATE OPEN_SUB.OS_SDATE%TYPE;
BEGIN
    SELECT OC_CODE INTO V_OCCODE
    FROM OPEN_SUB
    WHERE OS_CODE = P_OSCODE;
    
    SELECT OC_SDATE INTO V_DATE
    FROM OPEN_COURSE
    WHERE OC_CODE = V_OCCODE;
    
    -- 개설과정일 확인
    IF (SYSDATE > V_DATE)
        THEN RAISE USER_ERROR;
    END IF;
    
    DELETE 
    FROM OPEN_SUB
    WHERE OS_CODE = P_OSCODE;
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_ERROR
            THEN RAISE_APPLICATION_ERROR(-20037,'개설 과정 시작일이 지나 세부과목을 삭제할 수 없습니다');
                 --ROLLBACK;
END;

-- 중도 탈락 생성
CREATE OR REPLACE PROCEDURE PRC_DO_C
(
 P_ERCODE    DROP_OUT.ER_CODE%TYPE
,P_DODATE    DROP_OUT.DO_DATE%TYPE
,P_DRCODE    DROP_OUT.DR_CODE%TYPE
)
IS
    V_OCCODE  OPEN_COURSE.OC_CODE%TYPE;
    V_SDATE   OPEN_COURSE.OC_SDATE%TYPE;
    V_EDATE   OPEN_COURSE.OC_EDATE%TYPE;
BEGIN
    SELECT OC_CODE INTO V_OCCODE
    FROM ENROLLMENT
    WHERE ER_CODE = P_ERCODE;
    
    SELECT OC_SDATE,OC_EDATE INTO V_SDATE,V_EDATE
    FROM OPEN_COURSE
    WHERE OC_CODE = V_OCCODE;
    
    
    IF SYSDATE > V_EDATE
        THEN RAISE_APPLICATION_ERROR(-20038,'수강이 완료된 학생으로 중도탈락이 불가 합니다');
    ELSIF SYSDATE < V_SDATE
        THEN RAISE_APPLICATION_ERROR(-20040,'수강전 상태인 학생임으로 중도탈락이 불가 합니다');
    END IF;
    
    INSERT INTO DROP_OUT(DO_CODE,ER_CODE,DO_DATE,DR_CODE)
    VALUES('DO'||LPAD(SEQ_DROPOUT.NEXTVAL, 3,'0'),P_ERCODE
          ,P_DODATE,P_DRCODE);
          
    COMMIT;
    
END;

-- 중도탈락 수정
CREATE OR REPLACE PROCEDURE PRC_DO_U
(
 P_DOCODE   DROP_OUT.DO_CODE%TYPE
,P_ERCODE   DROP_OUT.ER_CODE%TYPE
,P_DODATE   DROP_OUT.DO_DATE%TYPE
,P_DRCODE   DROP_OUT.DR_CODE%TYPE
)
IS
    V_OCCODE OPEN_COURSE.OC_CODE%TYPE;
    V_SDATE   OPEN_COURSE.OC_SDATE%TYPE;
    V_EDATE   OPEN_COURSE.OC_EDATE%TYPE;
BEGIN

    SELECT OC_CODE INTO V_OCCODE
    FROM ENROLLMENT
    WHERE ER_CODE = P_ERCODE;
    
    SELECT OC_SDATE,OC_EDATE INTO V_SDATE,V_EDATE
    FROM OPEN_COURSE
    WHERE OC_CODE = V_OCCODE;
    
    
    IF SYSDATE > V_EDATE
        THEN RAISE_APPLICATION_ERROR(-20029,'수강이 완료된 학생으로 중도탈락이 불가 합니다');
    ELSIF SYSDATE < V_SDATE
        THEN RAISE_APPLICATION_ERROR(-20040,'수강전 상태인 학생임으로 중도탈락이 불가 합니다');
    END IF;
    
    UPDATE DROP_OUT
    SET ER_CODE = NVL(P_ERCODE,ER_CODE)
      , DO_DATE = NVL(P_DODATE,DO_DATE)
      , DR_CODE = NVL(P_DRCODE,DR_CODE)
    WHERE DO_CODE = P_DOCODE;
    
    COMMIT;
    
END;

-- 중도탈락 삭제
CREATE OR REPLACE PROCEDURE PRC_DO_D
(
P_DOCODE   DROP_OUT.DO_CODE%TYPE
)
IS
    V_DATE      DROP_OUT.DO_DATE%TYPE;
    V_SDATE     OPEN_SUB.OS_EDATE%TYPE;
    V_ERCODE    DROP_OUT.ER_CODE%TYPE;
    V_OCCODE   OPEN_COURSE.OC_CODE%TYPE;
BEGIN

    SELECT DO_DATE,ER_CODE INTO V_DATE,V_ERCODE
    FROM DROP_OUT
    WHERE DO_CODE = P_DOCODE;
    
    SELECT OC_CODE INTO V_OCCODE
    FROM ENROLLMENT
    WHERE ER_CODE = V_ERCODE;
    
    SELECT MIN(OS_EDATE) INTO V_SDATE
    FROM OPEN_SUB
    WHERE OC_CODE = V_OCCODE
    AND V_DATE <= OS_EDATE;
    
    IF V_SDATE < SYSDATE
        THEN RAISE_APPLICATION_ERROR(-20039,'중도탈락 취소가 불가능합니다');
    END IF;

    DELETE
    FROM DROP_OUT
    WHERE DO_CODE = P_DOCODE;
    
    COMMIT;
    
END;


-- 프로시저 생성
-- 프로시저명: PRC_GR_C
-- GRADE 테이블에 INSERT - 관리자, 교수자만 가능 (로그인아이디, 수강신청코드, 개설과목코드, 출결점수, 필기점수, 실기점수)
-- 교수자가 본인 과목에 한해서만 생성가능
-- 중도탈락 학생 제외
-- 수강신청의 수강신청코드가 중도탈락 중도탈락 테이블에 존재할 경우 탈락 일자를 확인
-- 탈락일자가 개설과목의 종료일시보다 빠른경우는 생성불가
CREATE OR REPLACE PROCEDURE PRC_GR_C_PF
(
 P_LOGIN_ID    IN  PROF.PF_ID%TYPE
)
IS
    V_LOGIN_ID  CHAR(2);
    V_DUP_CNT   NUMBER;
    
    USER_DEFINE_ERROR1  EXCEPTION;
BEGIN
    V_LOGIN_ID := SUBSTR(P_LOGIN_ID,1,2);
    
    IF (V_LOGIN_ID = 'PF') THEN
        -- 오늘 날짜와 과목의 종료 날짜를 비교해서 
        -- SYSDATE보다 종료날짜가 이전인 것들만 생성 가능하게 설정

         -- 중도탈락자가 아니면서 교수자의 과목인 컬럼들 
        FOR REC IN ( SELECT OS.OS_CODE, ER.ER_CODE, OS.OS_EDATE
                     FROM OPEN_SUB OS JOIN ENROLLMENT ER
                        ON ER.OC_CODE = OS.OC_CODE
                     WHERE OS.PF_ID = P_LOGIN_ID
                        AND OS.OS_EDATE <= TRUNC(SYSDATE)
                        AND NOT EXISTS( SELECT 1
                                        FROM DROP_OUT DO 
                                        WHERE DO.ER_CODE = ER.ER_CODE
                                          AND DO.DO_DATE <= OS.OS_EDATE)
                                       ) LOOP

            -- 중복 생성 방지
            -- ER_CODE, OS_CODE가 동일한게 있다면 생성방지
            SELECT COUNT(*) INTO V_DUP_CNT
            FROM GRADE
            WHERE ER_CODE = REC.ER_CODE AND OS_CODE = REC.OS_CODE;
            
            IF(V_DUP_CNT > 0) THEN
                CONTINUE;
            END IF;

            -- 데이터 삽입
            INSERT INTO GRADE(GR_CODE, ER_CODE, OS_CODE)
            VALUES('GR'||LPAD(GR_SEQ.NEXTVAL, 3, '0'), REC.ER_CODE, REC.OS_CODE);

        END LOOP;
    ELSE
        RAISE USER_DEFINE_ERROR1;
    END IF;
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_DEFINE_ERROR1 THEN
            RAISE_APPLICATION_ERROR(-20009, '권한이 없습니다.');
END;

CREATE OR REPLACE PROCEDURE PRC_GR_C_AD
( P_LOGIN_ID    IN  ADMIN.AD_ID%TYPE
, P_ER_CODE     IN  GRADE.ER_CODE%TYPE
, P_OS_CODE     IN  GRADE.OS_CODE%TYPE
, P_ATT_SCORE   IN  GRADE.ATT_SCORE%TYPE
, P_WRT_SCORE   IN  GRADE.WRT_SCORE%TYPE
, P_PRC_SCORE   IN  GRADE.PRC_SCORE%TYPE
)
IS
    V_LOGIN_ID          CHAR(2);
    V_OS_CNT            NUMBER;
    V_ER_CNT            NUMBER;
    V_DO_CNT            NUMBER;
    V_DUP_CNT           NUMBER;
    V_DO_DATE           DATE;
    V_OS_EDATE          DATE;
    V_OC_CODE           ENROLLMENT.OC_CODE%TYPE;
    V_FLAG              BOOLEAN:= FALSE;
    V_CNT               NUMBER;
    V_EDATE             DATE;
    
    USER_DEFINE_ERROR1  EXCEPTION;
    USER_DEFINE_ERROR2  EXCEPTION;
    USER_DEFINE_ERROR3  EXCEPTION;
    USER_DEFINE_ERROR4  EXCEPTION;
    USER_DEFINE_ERROR5  EXCEPTION;
    USER_DEFINE_ERROR6  EXCEPTION;
BEGIN
     V_LOGIN_ID := SUBSTR(P_LOGIN_ID,1,2);
    
    IF (V_LOGIN_ID = 'AD') THEN
    
        -- 과목 종료일 체크
        SELECT OS_EDATE INTO V_EDATE
        FROM OPEN_SUB
        WHERE OS_CODE = P_OS_CODE;
    
        IF (V_EDATE > TRUNC(SYSDATE))   THEN
            RAISE USER_DEFINE_ERROR6;
        END IF;

         -- 성적테이블에 중복데이터 존재 시 예외처리
        SELECT COUNT(*) INTO V_DUP_CNT
        FROM GRADE
        WHERE ER_CODE = P_ER_CODE AND OS_CODE = P_OS_CODE;
        
        IF(V_DUP_CNT > 0) THEN
            RAISE USER_DEFINE_ERROR3;
        END IF;
        
        
        -- P_OS_CODE와 P_ER_CODE가 실제로 서로 관계가 있는지 확인
        -- 개설과목코드 수강신청코드
        -- 수강신청테이블에 파라미터수강신청코드와 같은 수강신청코드에서 개설과정을 가져오고
        -- 그 개설과정코드가 개설과목에 들어있는 것 중에 파라미터로 받은 개설과목코드가 있는지 확인
        
        -- 데이터 없을 때 예외처리 
        SELECT COUNT(*)  INTO V_ER_CNT
        FROM ENROLLMENT
        WHERE ER_CODE = P_ER_CODE;
        
        SELECT COUNT(*) INTO V_OS_CNT
        FROM OPEN_SUB
        WHERE OS_CODE = P_OS_CODE;
        
        SELECT COUNT(ER.ER_CODE) INTO V_CNT
        FROM OPEN_SUB OS JOIN ENROLLMENT ER
         ON OS.OC_CODE = ER.OC_CODE
        WHERE OS.OS_CODE = P_OS_CODE;
        
        
        IF (V_OS_CNT = 0 OR V_ER_CNT = 0 OR V_CNT = 0) THEN
            RAISE USER_DEFINE_ERROR1;
        END IF;
        
        
        -- 수강신청테이블에서 파라미터로 받은 ER_CODE와 같은 행에서 OC_CODE 불러오기
        SELECT OC_CODE  INTO V_OC_CODE
        FROM ENROLLMENT
        WHERE ER_CODE = P_ER_CODE;
   
        -- 개설과목코드들
        FOR R_OS_CODE IN ( SELECT OS_CODE 
                           FROM OPEN_SUB
                           WHERE OC_CODE = V_OC_CODE
                          ) LOOP
            -- 개설과목코드와 파라미터개설과목코드가 같은 게 하나라도 있으면 TRUE 
            IF R_OS_CODE.OS_CODE = P_OS_CODE    THEN
                V_FLAG := TRUE;
                EXIT;
            END IF;   
        END LOOP;
        
        -- 개설과목코드에 파라미터개설과목코드가 같은게 없다면 예외처리
        IF NOT V_FLAG THEN
            RAISE USER_DEFINE_ERROR5;
        END IF;
        
          -- 중도탈락 학생 예외처리           
                SELECT OS_EDATE INTO V_OS_EDATE
                FROM OPEN_SUB
                WHERE OS_CODE = P_OS_CODE;
                
                SELECT COUNT(*) INTO V_DO_CNT
                FROM DROP_OUT
                WHERE ER_CODE = P_ER_CODE;
                
                IF(V_DO_CNT > 0) THEN
                    SELECT DO_DATE  INTO V_DO_DATE
                    FROM DROP_OUT
                    WHERE ER_CODE = P_ER_CODE;
                    IF (V_DO_DATE <= V_OS_EDATE) THEN
                        RAISE USER_DEFINE_ERROR4;
                    ELSE
                        INSERT INTO GRADE(GR_CODE, ER_CODE, OS_CODE, ATT_SCORE, WRT_SCORE, PRC_SCORE)
                        VALUES('GR'||LPAD(GR_SEQ.NEXTVAL, 3, '0'), P_ER_CODE, P_OS_CODE, P_ATT_SCORE, P_WRT_SCORE, P_PRC_SCORE);
                    END IF;
                ELSE
                    INSERT INTO GRADE(GR_CODE, ER_CODE, OS_CODE, ATT_SCORE, WRT_SCORE, PRC_SCORE)
                    VALUES('GR'||LPAD(GR_SEQ.NEXTVAL, 3, '0'), P_ER_CODE, P_OS_CODE, P_ATT_SCORE, P_WRT_SCORE, P_PRC_SCORE);
                END IF; 
    ELSE
        RAISE USER_DEFINE_ERROR2;
    END IF;
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_DEFINE_ERROR1 THEN
            RAISE_APPLICATION_ERROR(-20006, '데이터가 존재하지 않습니다.');
        WHEN USER_DEFINE_ERROR2 THEN
            RAISE_APPLICATION_ERROR(-20009, '권한이 없습니다.');
        WHEN USER_DEFINE_ERROR3 THEN
            RAISE_APPLICATION_ERROR(-20010, '유효하지 않은 파라미터입니다.');
        WHEN USER_DEFINE_ERROR4 THEN
            RAISE_APPLICATION_ERROR(-20011, '중도탈락한 학생입니다.');
        WHEN USER_DEFINE_ERROR5 THEN
            RAISE_APPLICATION_ERROR(-20012, '유효한 개설과목이 존재하지 않습니다.');
        WHEN USER_DEFINE_ERROR6 THEN
            RAISE_APPLICATION_ERROR(-20029, '선택한 과목은 종료되지 않았습니다.');  
END;

CREATE OR REPLACE PROCEDURE PRC_GR_U
( P_LOGIN_ID    IN  ADMIN.AD_ID%TYPE
, P_GR_CODE     IN  GRADE.GR_CODE%TYPE
, P_ATT_SCORE   IN  GRADE.ATT_SCORE%TYPE
, P_WRT_SCORE   IN  GRADE.WRT_SCORE%TYPE
, P_PRC_SCORE   IN  GRADE.PRC_SCORE%TYPE
)
IS

    V_LOGIN_ID  CHAR(2);
    V_OS_CODE   OPEN_SUB.OS_CODE%TYPE;
    V_PF_ID     OPEN_SUB.PF_ID%TYPE;
    V_CNT       NUMBER;
    
    USER_DEFINE_ERROR1  EXCEPTION;
    USER_DEFINE_ERROR2  EXCEPTION;
    USER_DEFINE_ERROR3  EXCEPTION;
    
BEGIN
    V_LOGIN_ID := SUBSTR(P_LOGIN_ID,1,2);
    
    SELECT OS_CODE  INTO V_OS_CODE
    FROM GRADE
    WHERE GR_CODE = P_GR_CODE;
    
    
    -- 교수일 때
    IF(V_LOGIN_ID = 'PF') THEN
        -- 입력한 성적코드가 본인 담당인지 확인 후 업데이트
        
        SELECT PF_ID    INTO V_PF_ID
        FROM OPEN_SUB
        WHERE OS_CODE = V_OS_CODE;
        
        IF(V_PF_ID != P_LOGIN_ID) THEN
            RAISE USER_DEFINE_ERROR3;
        END IF;
  
    
        UPDATE GRADE 
        SET ATT_SCORE = NVL(P_ATT_SCORE,ATT_SCORE), WRT_SCORE = NVL(P_WRT_SCORE, WRT_SCORE), PRC_SCORE = NVL(P_PRC_SCORE, PRC_SCORE)
        WHERE GR_CODE = P_GR_CODE;
    
        IF SQL%ROWCOUNT > 0 THEN
            DBMS_OUTPUT.PUT_LINE('정상적으로 업데이트 되었습니다.');
        END IF;
    
    -- 관리자일 때
    ELSIF (V_LOGIN_ID = 'AD') THEN
    
        UPDATE GRADE 
        SET ATT_SCORE = NVL(P_ATT_SCORE,ATT_SCORE), WRT_SCORE = NVL(P_WRT_SCORE, WRT_SCORE), PRC_SCORE = NVL(P_PRC_SCORE, PRC_SCORE)
        WHERE GR_CODE = P_GR_CODE;
        
        IF SQL%ROWCOUNT > 0 THEN
            DBMS_OUTPUT.PUT_LINE('정상적으로 업데이트 되었습니다.');
        END IF;
    
    -- 권한없는 계정일 때
    ELSE
        RAISE USER_DEFINE_ERROR1;
    END IF;
    
    
    COMMIT;
    
    EXCEPTION
        WHEN USER_DEFINE_ERROR1 THEN
            RAISE_APPLICATION_ERROR(-20009,'권한이 없습니다.');
        WHEN USER_DEFINE_ERROR2 THEN
            RAISE_APPLICATION_ERROR(-20006,'데이터가 존재하지 않습니다.');
        WHEN USER_DEFINE_ERROR3 THEN
            RAISE_APPLICATION_ERROR(-20030,'본인의 담당 과목이 아닙니다.');
        WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20031, '유효하지 않은 성적코드입니다.');
END;


CREATE OR REPLACE PROCEDURE PRC_GR_D
( P_LOGIN_ID    IN  ADMIN.AD_ID%TYPE
, GR_CODE       IN  GRADE.GR_CODE%TYPE
)
IS
    V_LOGIN_ID  CHAR(2);
    
    USER_DEFINE_ERROR1  EXCEPTION;
    USER_DEFINE_ERROR2  EXCEPTION;
BEGIN
    V_LOGIN_ID := SUBSTR(P_LOGIN_ID,1,2);    
    IF (V_LOGIN_ID IN ('PF','AD')) THEN
        RAISE USER_DEFINE_ERROR2;
    ELSE
        RAISE USER_DEFINE_ERROR1;
    END IF;

    COMMIT;
    
    EXCEPTION
        WHEN USER_DEFINE_ERROR1 THEN
            RAISE_APPLICATION_ERROR(-20009,'권한이 없습니다.');
        WHEN USER_DEFINE_ERROR2 THEN
            RAISE_APPLICATION_ERROR(-20013,'삭제할 수 있는 성적이 없습니다.');
END;


-- 수강신청 생성
CREATE OR REPLACE PROCEDURE PRC_ER_C
(
  P_OC_CODE IN ENROLLMENT.OC_CODE%TYPE,
  P_ST_ID   IN ENROLLMENT.ST_ID%TYPE
)
IS
    V_OC_CNT     NUMBER;
    V_ST_CNT     NUMBER;
    V_DUP_CNT    NUMBER;
    V_OC_SDATE   DATE;
    
BEGIN  
    -- 개설과정 존재 및 시작일 확인
    SELECT COUNT(*)
    INTO V_OC_CNT
    FROM OPEN_COURSE
    WHERE OC_CODE = P_OC_CODE;
    
    IF V_OC_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20023, '존재하지 않는 개설과정입니다.');
    END IF;
    
    -- 수강신청날짜가 개설과정 시작일보다 작아야함
    -- 개설과정이 열리고 그 이후에 수강신청 가능
    SELECT OC_SDATE INTO V_OC_SDATE
    FROM OPEN_COURSE
    WHERE OC_CODE = P_OC_CODE;
    
    -- 시작 과정 확인
    IF V_OC_SDATE < SYSDATE THEN
        RAISE_APPLICATION_ERROR(-20024, '시작된 과정에는 수강신청할 수 없습니다.');
    END IF;
    
    -- 학생 존재 확인
    SELECT COUNT(*) INTO V_ST_CNT
    FROM STUD
    WHERE ST_ID = P_ST_ID;

    IF V_ST_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20025, '존재하지 않는 학생입니다.');
    END IF;
     
    -- 중복 수강신청 확인
    SELECT COUNT(*) INTO V_DUP_CNT
    FROM ENROLLMENT 
    WHERE OC_CODE = P_OC_CODE
      AND ST_ID = P_ST_ID;
     
    IF V_DUP_CNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20026, '이미 수강신청한 과정입니다.');
    END IF;
     
    INSERT INTO ENROLLMENT (ER_CODE, OC_CODE, ST_ID)
    VALUES('ER' || LPAD(ER_SEQ.NEXTVAL, 3, '0'), P_OC_CODE, P_ST_ID);
    
    COMMIT;
    
END;

-- 수강신청 수정
CREATE OR REPLACE PROCEDURE PRC_ER_U
(
  P_ER_CODE IN ENROLLMENT.ER_CODE%TYPE,
  P_OC_CODE IN ENROLLMENT.OC_CODE%TYPE
)
IS
  V_ER_CNT   NUMBER;
  V_OC_CNT   NUMBER;
  V_DUP_CNT  NUMBER;
  V_ST_ID    STUD.ST_ID%TYPE;
BEGIN
    -- 수강신청 존재 확인
    SELECT COUNT(*) INTO V_ER_CNT
    FROM ENROLLMENT
    WHERE ER_CODE = P_ER_CODE;

    IF V_ER_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20027, '존재하지 않는 수강신청입니다.');
    END IF;

    -- 변경할 개설과정 존재 확인
    SELECT COUNT(*) INTO V_OC_CNT
    FROM OPEN_COURSE
    WHERE OC_CODE = P_OC_CODE;

    IF V_OC_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20020, '수정할 개설과정이 존재하지 않습니다.');
    END IF;

    -- 현재 수강신청의 학생ID 조회
    SELECT ST_ID INTO V_ST_ID
    FROM ENROLLMENT
    WHERE ER_CODE = P_ER_CODE;

    -- 중복 수강 확인 (같은 학생이 이미 해당 과정 수강 중인지)
    SELECT COUNT(*) INTO V_DUP_CNT
    FROM ENROLLMENT
    WHERE OC_CODE = P_OC_CODE
      AND ST_ID = V_ST_ID
      AND ER_CODE = P_ER_CODE;

    IF V_DUP_CNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20026, '이미 수강신청한 과정입니다.');
    END IF;

    UPDATE ENROLLMENT
    SET OC_CODE = P_OC_CODE
    WHERE ER_CODE = P_ER_CODE;
    
    COMMIT;
    
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20004, '수정 대상이 존재하지 않습니다.');
    END IF;
END;

-- 수강신청 삭제
CREATE OR REPLACE PROCEDURE PRC_ER_D
(
  P_ER_CODE IN ENROLLMENT.ER_CODE%TYPE
)
IS
    V_ER_CNT    NUMBER;
    V_DROP_CNT  NUMBER;
    V_GRADE_CNT NUMBER;
BEGIN    
    -- 수강신청 존재 확인
    SELECT COUNT(*) INTO V_ER_CNT
    FROM ENROLLMENT
    WHERE ER_CODE = P_ER_CODE;

    IF V_ER_CNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20005, '삭제 대상이 존재하지 않습니다.');
    END IF;

    -- 중도탈락 데이터 확인
    SELECT COUNT(*) INTO V_DROP_CNT
    FROM DROP_OUT
    WHERE ER_CODE = P_ER_CODE; 
    
    -- 성적 데이터 확인
    SELECT COUNT(*) INTO V_GRADE_CNT
    FROM GRADE
    WHERE ER_CODE = P_ER_CODE;
     
    IF V_DROP_CNT > 0 OR V_GRADE_CNT > 0 THEN
        RAISE_APPLICATION_ERROR(-20028, '중도탈락 또는 성적 데이터가 존재하여 삭제할 수 없습니다.');
    END IF;
    
    DELETE FROM ENROLLMENT
    WHERE ER_CODE = P_ER_CODE;
    
    COMMIT;
    
    IF SQL%ROWCOUNT = 0 THEN
        RAISE_APPLICATION_ERROR(-20005, '삭제 대상이 존재하지 않습니다.');
    END IF;
    
END;




-- 샘플데이터 모두 삭제 ---------------------------------------------------

--○ 샘플데이터 지우기
DELETE FROM GRADE;
DELETE FROM DROP_OUT;
DELETE FROM ENROLLMENT;
DELETE FROM OPEN_SUB;
DELETE FROM OPEN_COURSE;
DELETE FROM ADMIN;
DELETE FROM DROP_REASON;
DELETE FROM ADMIN_ROLE;
DELETE FROM CLASS;
DELETE FROM TEXTBOOK;
DELETE FROM SUB;
DELETE FROM COURSE;
DELETE FROM STUD;
DELETE FROM PROF;

SELECT * FROM GRADE;
SELECT * FROM DROP_OUT;
SELECT * FROM ENROLLMENT;
SELECT * FROM OPEN_SUB;
SELECT * FROM OPEN_COURSE;
SELECT * FROM ADMIN;
SELECT * FROM DROP_REASON;
SELECT * FROM ADMIN_ROLE;
SELECT * FROM CLASS;
SELECT * FROM TEXTBOOK;
SELECT * FROM SUB;
SELECT * FROM COURSE;
SELECT * FROM STUD;
SELECT * FROM PROF;


--------------------------------------------------------------------------------
-- 프로시저 데이터 삽입 실행 ----------------------------------------------
--○ 프로시저로 데이터 입력

-- 1. ADMIN_ROLE (관리자등급)
-- EXEC PRC_AR_CUD(MODE, AR_CODE, AR_NAME)
EXEC PRC_AR_CUD('C','AR001','최종관리자');
EXEC PRC_AR_CUD('C','AR002','관리자');

SELECT * FROM ADMIN_ROLE;
--==>>
/*
AR001	최종관리자
AR002	관리자
*/

-- 2. CLASS (강의실)
-- EXEC PRC_CL_CUD(MODE, CL_CODE, CL_NAME)
EXEC PRC_CL_CUD('C','CL001','A강의실');
EXEC PRC_CL_CUD('C','CL002','B강의실');
EXEC PRC_CL_CUD('C','CL003','C강의실');

SELECT * FROM CLASS;
--==>>
/*
CL001	A강의실
CL002	B강의실
CL003	C강의실
*/


-- 3. DROP_REASON (탈락사유)
-- EXEC PRC_DR_CUD(MODE, DR_CODE, DR_REASON)
EXEC PRC_DR_CUD('C','DR001','개인사정');
EXEC PRC_DR_CUD('C','DR002','취업');
EXEC PRC_DR_CUD('C','DR003','무단결석');

SELECT * FROM DROP_REASON;
--==>>
/*
DR001	개인사정
DR002	취업
DR003	무단결석
*/


-- 4. TEXTBOOK (교재)
-- EXEC PRC_TB_CUD(MODE, TB_CODE, TB_NAME)
EXEC PRC_TB_CUD('C','TB001','Java 입문');
EXEC PRC_TB_CUD('C','TB002','Spring Boot 실습');
EXEC PRC_TB_CUD('C','TB003','SQL 기본');
EXEC PRC_TB_CUD('C','TB004','HTML CSS 가이드');
EXEC PRC_TB_CUD('C','TB005','JavaScript 핵심');
EXEC PRC_TB_CUD('C','TB006','React 실전');

SELECT * FROM TEXTBOOK;
--==>>
/*
TB001	Java 입문
TB002	Spring Boot 실습
TB003	SQL 기본
TB004	HTML CSS 가이드
TB005	JavaScript 핵심
TB006	React 실전
*/



-- 5. COURSE (과정)
-- EXEC PRC_CR_C(CR_CODE, CR_NAME)
EXEC PRC_CR_C('CR001','백엔드과정');
EXEC PRC_CR_C('CR002','프론트엔드과정');
EXEC PRC_CR_C('CR003','풀스택과정');

SELECT * FROM COURSE;
--==>>
/*
CR001	백엔드과정
CR002	프론트엔드과정
CR003	풀스택과정
*/

-- 6. SUB (과목)
-- EXEC PRC_SUB_CUD(MODE, SUB_CODE, SUB_NAME)
EXEC PRC_SUB_CUD('C','SUB001','Java');
EXEC PRC_SUB_CUD('C','SUB002','SQL');
EXEC PRC_SUB_CUD('C','SUB003','Spring');
EXEC PRC_SUB_CUD('C','SUB004','HTML/CSS');
EXEC PRC_SUB_CUD('C','SUB005','Javascript');
EXEC PRC_SUB_CUD('C','SUB006','React');

SELECT * FROM SUB;
--==>>
/*
SUB001	Java
SUB002	SQL
SUB003	Spring
SUB004	HTML/CSS
SUB005	Javascript
SUB006	React
*/


-- 7. PROF (교수자)
-- EXEC PRC_PF_C(PF_NAME, PF_SSN)
EXEC PRC_PF_C('박교수','800101-1234567');
EXEC PRC_PF_C('최교수','810202-2345678');
EXEC PRC_PF_C('김교수','880914-2122333');

--※ DEFAULT 날짜 수정 UPDATE
UPDATE PROF SET PF_DATE = TO_DATE('2024-01-10','YYYY-MM-DD') WHERE PF_ID = 'PF100';
UPDATE PROF SET PF_DATE = TO_DATE('2024-01-11','YYYY-MM-DD') WHERE PF_ID = 'PF101';
UPDATE PROF SET PF_DATE = TO_DATE('2024-01-12','YYYY-MM-DD') WHERE PF_ID = 'PF102';

SELECT * FROM PROF;
--==>>
/*
PF100	박교수	800101-1234567	1234567	2024-01-10
PF101	최교수	810202-2345678	2345678	2024-01-11
PF102	김교수	880914-2122333	2122333	2024-01-12
*/



-- 8. STUD (학생)
-- EXEC PRC_ST_C(ST_NAME,ST_SSN)
EXEC PRC_ST_C('김학생','000904-3123456');
EXEC PRC_ST_C('유학생','010101-4123456');
EXEC PRC_ST_C('박학생','970202-1123456');
EXEC PRC_ST_C('최학생','940515-1145677');
EXEC PRC_ST_C('정학생','990414-2233547');
EXEC PRC_ST_C('조학생','991124-1155111');

--※ DEFAULT 날짜 수정 UPDATE
UPDATE STUD SET ST_DATE = TO_DATE('2024-01-15','YYYY-MM-DD') WHERE ST_ID = 'ST100';
UPDATE STUD SET ST_DATE = TO_DATE('2024-01-16','YYYY-MM-DD') WHERE ST_ID = 'ST101';
UPDATE STUD SET ST_DATE = TO_DATE('2024-01-17','YYYY-MM-DD') WHERE ST_ID = 'ST102';
UPDATE STUD SET ST_DATE = TO_DATE('2025-01-05','YYYY-MM-DD') WHERE ST_ID = 'ST103';
UPDATE STUD SET ST_DATE = TO_DATE('2025-01-06','YYYY-MM-DD') WHERE ST_ID = 'ST104';
UPDATE STUD SET ST_DATE = TO_DATE('2025-01-07','YYYY-MM-DD') WHERE ST_ID = 'ST105';

UPDATE STUD SET ST_DATE = TO_DATE('2024-01-15','YYYY-MM-DD') WHERE ST_ID = 'ST106';
UPDATE STUD SET ST_DATE = TO_DATE('2024-01-16','YYYY-MM-DD') WHERE ST_ID = 'ST107';
UPDATE STUD SET ST_DATE = TO_DATE('2024-01-17','YYYY-MM-DD') WHERE ST_ID = 'ST108';
UPDATE STUD SET ST_DATE = TO_DATE('2025-01-05','YYYY-MM-DD') WHERE ST_ID = 'ST109';
UPDATE STUD SET ST_DATE = TO_DATE('2025-01-06','YYYY-MM-DD') WHERE ST_ID = 'ST110';
UPDATE STUD SET ST_DATE = TO_DATE('2025-01-07','YYYY-MM-DD') WHERE ST_ID = 'ST111';

SELECT * FROM STUD;
--==>>
/*
ST100	3123456	김학생	000904-3123456	2024-01-15
ST101	4123456	유학생	010101-4123456	2024-01-16
ST102	1123456	박학생	970202-1123456	2024-01-17
ST103	1145677	최학생	940515-1145677	2025-01-05
ST104	2233547	정학생	990414-2233547	2025-01-06
ST105	1155111	조학생	991124-1155111	2025-01-07
*/

-- 9. ADMIN (관리자)
-- EXEC PRC_AD_C(AD_NAME, AD_SSN, AR_CODE)
EXEC PRC_AD_C('조관리','790102-2777777','AR001');
EXEC PRC_AD_C('김관리','751010-1122333','AR002');
EXEC PRC_AD_C('이관리','890810-1552147','AR002');

--※ DEFAULT 날짜 수정 UPDATE
UPDATE ADMIN SET AD_DATE = TO_DATE('2023-01-01','YYYY-MM-DD') WHERE AD_ID = 'AD100';
UPDATE ADMIN SET AD_DATE = TO_DATE('2023-01-02','YYYY-MM-DD') WHERE AD_ID = 'AD101';
UPDATE ADMIN SET AD_DATE = TO_DATE('2024-01-03','YYYY-MM-DD') WHERE AD_ID = 'AD102';

UPDATE ADMIN SET AD_DATE = TO_DATE('2023-01-01','YYYY-MM-DD') WHERE AD_ID = 'AD103';
UPDATE ADMIN SET AD_DATE = TO_DATE('2023-01-02','YYYY-MM-DD') WHERE AD_ID = 'AD104';
UPDATE ADMIN SET AD_DATE = TO_DATE('2024-01-03','YYYY-MM-DD') WHERE AD_ID = 'AD105';

SELECT * FROM ADMIN;
--==>>
/*
AD100                2777777              조관리               790102-2777777 2023-01-01 AR001     
AD101                1122333              김관리               751010-1122333 2023-01-02 AR002     
AD102                1552147              이관리               890810-1552147 2024-01-03 AR002     
*/



-- 10. OPEN_COURSE (개설과정)
-- EXEC PRC_OC_C(CR_CODE, OC_SDATE, OC_EDATE, CL_CODE)
EXEC PRC_OC_C('CR001', TO_DATE('2024-09-01','YYYY-MM-DD'), TO_DATE('2025-02-28','YYYY-MM-DD'), 'CL001');
EXEC PRC_OC_C('CR002', TO_DATE('2025-09-01','YYYY-MM-DD'), TO_DATE('2026-02-28','YYYY-MM-DD'), 'CL002');
EXEC PRC_OC_C('CR003', TO_DATE('2026-03-01','YYYY-MM-DD'), TO_DATE('2026-08-31','YYYY-MM-DD'), 'CL003');


--※ DEFAULT 날짜 수정 UPDATE
UPDATE OPEN_COURSE SET OC_DATE = TO_DATE('2024-08-10','YYYY-MM-DD') WHERE OC_CODE = 'OC001';
UPDATE OPEN_COURSE SET OC_DATE = TO_DATE('2025-08-10','YYYY-MM-DD') WHERE OC_CODE = 'OC002';
UPDATE OPEN_COURSE SET OC_DATE = TO_DATE('2026-02-01','YYYY-MM-DD') WHERE OC_CODE = 'OC003';

UPDATE OPEN_COURSE SET OC_DATE = TO_DATE('2024-08-10','YYYY-MM-DD') WHERE OC_CODE = 'OC004';
UPDATE OPEN_COURSE SET OC_DATE = TO_DATE('2025-08-10','YYYY-MM-DD') WHERE OC_CODE = 'OC005';
UPDATE OPEN_COURSE SET OC_DATE = TO_DATE('2026-02-01','YYYY-MM-DD') WHERE OC_CODE = 'OC006';

SELECT * FROM OPEN_COURSE;
--==>>
/*
OC001	CR001	2024-09-01	2025-02-28	CL001	2024-08-10
OC002	CR002	2025-09-01	2026-02-28	CL002	2025-08-10
OC003	CR003	2026-03-01	2026-08-31	CL003	2026-02-01
*/




-- 11. OPEN_SUB (개설과목)
-- EXEC PRC_OS_C(OC_CODE, PF_ID, SUB_CODE, OS_SDATE, OS_EDATE, TB_CODE)

EXEC PRC_OS_C('OC001','PF101','SUB001', TO_DATE('2024-09-01','YYYY-MM-DD'), TO_DATE('2024-10-31','YYYY-MM-DD'), 'TB001');

EXEC PRC_OS_C('OC001','PF100','SUB002', TO_DATE('2024-11-01','YYYY-MM-DD'), TO_DATE('2024-12-31','YYYY-MM-DD'), 'TB003');

EXEC PRC_OS_C('OC001','PF100','SUB003', TO_DATE('2025-01-01','YYYY-MM-DD'), TO_DATE('2025-02-28','YYYY-MM-DD'), 'TB002');

EXEC PRC_OS_C('OC002','PF102','SUB004', TO_DATE('2025-09-01','YYYY-MM-DD'), TO_DATE('2025-10-31','YYYY-MM-DD'), 'TB004');

EXEC PRC_OS_C('OC002','PF102','SUB005', TO_DATE('2025-11-01','YYYY-MM-DD'), TO_DATE('2025-12-31','YYYY-MM-DD'), 'TB005');

EXEC PRC_OS_C('OC002','PF101','SUB006', TO_DATE('2026-01-01','YYYY-MM-DD'), TO_DATE('2026-02-28','YYYY-MM-DD'), 'TB006');

EXEC PRC_OS_C('OC003','PF101','SUB001', TO_DATE('2026-03-01','YYYY-MM-DD'), TO_DATE('2026-04-30','YYYY-MM-DD'), 'TB001');
 
EXEC PRC_OS_C('OC003','PF102','SUB005', TO_DATE('2026-05-01','YYYY-MM-DD'), TO_DATE('2026-06-30','YYYY-MM-DD'), 'TB005');

EXEC PRC_OS_C('OC003','PF100','SUB006', TO_DATE('2026-07-01','YYYY-MM-DD'), TO_DATE('2026-08-31','YYYY-MM-DD'), 'TB006');


--※ DEFAULT 날짜 수정 UPDATE
UPDATE OPEN_SUB SET OS_DATE = TO_DATE('2024-08-10','YYYY-MM-DD') WHERE OC_CODE = 'OC001';
UPDATE OPEN_SUB SET OS_DATE = TO_DATE('2025-08-10','YYYY-MM-DD') WHERE OC_CODE = 'OC002';
UPDATE OPEN_SUB SET OS_DATE = TO_DATE('2026-02-01','YYYY-MM-DD') WHERE OC_CODE = 'OC003';

SELECT * FROM OPEN_SUB;
--==>>
/*
OS002	OC001	PF101	SUB001	2024-09-01	2024-10-31	TB001				2024-08-10
OS003	OC001	PF100	SUB002	2024-11-01	2024-12-31	TB003				2024-08-10
OS004	OC001	PF100	SUB003	2025-01-01	2025-02-28	TB002				2024-08-10
OS005	OC002	PF102	SUB004	2025-09-01	2025-10-31	TB004				2025-08-10
OS006	OC002	PF102	SUB005	2025-11-01	2025-12-31	TB005				2025-08-10
OS007	OC002	PF101	SUB006	2026-01-01	2026-02-28	TB006				2025-08-10
OS008	OC003	PF101	SUB001	2026-03-01	2026-04-30	TB001				2026-02-01
OS009	OC003	PF102	SUB005	2026-05-01	2026-06-30	TB005				2026-02-01
OS010	OC003	PF100	SUB006	2026-07-01	2026-08-31	TB006				2026-02-01
*/



-- 12. ENROLLMENT (수강신청)

-- 과거 수강 이력은 INSERT쿼리로 바로 삽입
INSERT INTO ENROLLMENT VALUES ('ER001','OC001','ST100',TO_DATE('2024-08-20','YYYY-MM-DD'));
INSERT INTO ENROLLMENT VALUES ('ER002','OC001','ST101',TO_DATE('2024-08-21','YYYY-MM-DD'));
INSERT INTO ENROLLMENT VALUES ('ER003','OC001','ST102',TO_DATE('2024-08-22','YYYY-MM-DD'));
INSERT INTO ENROLLMENT VALUES ('ER004','OC002','ST103',TO_DATE('2025-08-20','YYYY-MM-DD'));
INSERT INTO ENROLLMENT VALUES ('ER005','OC002','ST104',TO_DATE('2025-08-21','YYYY-MM-DD'));
INSERT INTO ENROLLMENT VALUES ('ER006','OC002','ST105',TO_DATE('2025-08-22','YYYY-MM-DD'));



-- EXEC PRC_ER_C(OC_CODE, ST_ID)
EXEC PRC_ER_C('OC003','ST100');
EXEC PRC_ER_C('OC003','ST101');
EXEC PRC_ER_C('OC003','ST102');

SELECT * FROM ENROLLMENT;
--==>>
/*
ER001	OC001	ST100	2024-08-20
ER002	OC001	ST101	2024-08-21
ER003	OC001	ST102	2024-08-22
ER004	OC002	ST103	2025-08-20
ER005	OC002	ST104	2025-08-21
ER006	OC002	ST105	2025-08-22
ER007	OC003	ST100	2026-01-28
ER008	OC003	ST101	2026-01-28
ER009	OC003	ST102	2026-01-28
*/

-- 13. GRADE (성적)
-- EXEC PRC_GR_C_AD(LOGIN_ID, ER_CODE, OS_CODE, ATT_SOCRE, WRT_SCORE, PRC_SCORE)
EXEC PRC_GR_C_AD('AD102','ER001','OS002',18,24,41);
EXEC PRC_GR_C_AD('AD102','ER002','OS002',20,26,45);
EXEC PRC_GR_C_AD('AD102','ER002','OS003',17,33,36);
EXEC PRC_GR_C_AD('AD102','ER004','OS005',18,32,34);
EXEC PRC_GR_C_AD('AD102','ER005','OS005',20,30,35);
EXEC PRC_GR_C_AD('AD102','ER006','OS005',16,28,33);
EXEC PRC_GR_C_AD('AD102','ER004','OS006',27,22,34);
EXEC PRC_GR_C_AD('AD102','ER005','OS006',30,20,35);
EXEC PRC_GR_C_AD('AD102','ER006','OS006',24,25,33);


UPDATE GRADE
SET GR_DATE = TO_DATE('2024-11-02','YYYY-MM-DD')
WHERE GR_CODE = 'GR001';

UPDATE GRADE
SET GR_DATE = TO_DATE('2024-12-15','YYYY-MM-DD')
WHERE GR_CODE = 'GR002';
UPDATE GRADE
SET GR_DATE = TO_DATE('2025-11-02','YYYY-MM-DD')
WHERE GR_CODE IN ('GR003','GR004','GR005');
UPDATE GRADE
SET GR_DATE = TO_DATE('2026-01-02','YYYY-MM-DD')
WHERE GR_CODE IN ('GR006','GR007','GR008');

UPDATE GRADE
SET GR_DATE = TO_DATE('2025-01-10','YYYY-MM-DD')
WHERE GR_CODE = 'GR003';


DELETE FROM GRADE;

SELECT * FROM GRADE;
--==>>
/*
GR001   ER001   OS002   18   24   41   2024-11-02
GR002   ER002   OS002   20   26   45   2024-12-15
GR003   ER002   OS003   17   33   36   2025-01-10
GR004   ER004   OS005   18   32   34   2025-11-02
GR005   ER005   OS005   20   30   35   2025-11-02
GR006   ER006   OS005   16   28   33   2026-01-02
GR007   ER004   OS006   27   22   34   2026-01-02
GR008   ER005   OS006   30   20   35   2026-01-02
GR009   ER006   OS006   24   25   33   2026-01-29
*/
-- 14. DROP_OUT (중도탈락)

-- 과거 이력은 INSERT 쿼리로 삽입
INSERT INTO DROP_OUT (DO_CODE, ER_CODE, DO_DATE, DR_CODE)
VALUES ('DO001','ER001',TO_DATE('2024-11-15','YYYY-MM-DD'),'DR001');
INSERT INTO DROP_OUT (DO_CODE, ER_CODE, DO_DATE, DR_CODE)
VALUES ('DO002','ER002',TO_DATE('2025-01-15','YYYY-MM-DD'),'DR002');

-- EXEC PRC_DO_C(ER_CODE, DO_DATE, DR_CODE)
EXEC PRC_DO_C('ER004', TO_DATE('2026-01-20','YYYY-MM-DD'), 'DR003');

SELECT * 
FROM DROP_OUT;
--==>>
/*
DO001	ER001	2024-11-15	DR001
DO002	ER002	2025-01-15	DR002
DO003	ER004	2026-01-20	DR003
*/
-------------------------------------------------------------------------
-- 관리자용 - 교수자 배정 현황 뷰
CREATE OR REPLACE VIEW VIEW_ADMIN_PROF_LIST AS
SELECT
     P.PF_ID
    ,P.PF_NAME AS 교수자명
    ,S.SUB_NAME AS 과목명
    ,OS.OS_SDATE AS 시작일시
    ,OS.OS_EDATE AS 종료일시
    ,T.TB_NAME AS 교재명
    ,C.CL_NAME AS 강의실
    ,CASE
     WHEN SYSDATE < OS.OS_SDATE THEN '강의 예정'
     WHEN SYSDATE BETWEEN OS.OS_SDATE AND OS.OS_EDATE THEN '강의 중'
     ELSE '강의 종료'
     END AS 강의진행여부
FROM PROF P
LEFT JOIN OPEN_SUB OS ON P.PF_ID = OS.PF_ID
LEFT JOIN SUB S ON OS.SUB_CODE = S.SUB_CODE
LEFT JOIN TEXTBOOK T ON OS.TB_CODE = T.TB_CODE
LEFT JOIN OPEN_COURSE OC ON OS.OC_CODE = OC.OC_CODE
LEFT JOIN CLASS C ON OC.CL_CODE = C.CL_CODE;

-- 관리자용 - 과정 상세 정보 뷰
CREATE OR REPLACE VIEW VIEW_ADMIN_COURSE_LIST AS
SELECT
     CR.CR_CODE
    ,CR.CR_NAME AS 과정명
    ,CL.CL_NAME AS 강의실
    ,S.SUB_NAME AS 과목명
    ,OS.OS_SDATE AS 시작일시
    ,OS.OS_EDATE AS 종료일시
    ,T.TB_NAME AS 교재명
    ,P.PF_NAME AS 교수자명
FROM COURSE CR
LEFT JOIN OPEN_COURSE OC ON CR.CR_CODE = OC.CR_CODE
LEFT JOIN CLASS CL ON OC.CL_CODE = CL.CL_CODE
LEFT JOIN OPEN_SUB OS ON OC.OC_CODE = OS.OC_CODE
LEFT JOIN SUB S ON OS.SUB_CODE = S.SUB_CODE
LEFT JOIN TEXTBOOK T ON OS.TB_CODE = T.TB_CODE
LEFT JOIN PROF P ON OS.PF_ID = P.PF_ID;


-- 관리자용 - 과목 상세 정보 뷰
CREATE OR REPLACE VIEW VIEW_ADMIN_SUBJECT_LIST AS
SELECT
     OS.OS_CODE
    ,CR.CR_NAME AS 과정명
    ,CL.CL_NAME AS 강의실
    ,S.SUB_NAME AS 과목명
    ,OS.OS_SDATE AS 시작일시
    ,OS.OS_EDATE AS 종료일시
    ,T.TB_NAME AS 교재명
    ,P.PF_NAME AS 교수자명
    ,OS.ATT_WEIGHT AS 출결배점
    ,OS.WRT_WEIGHT AS 필기배점
    ,OS.PRC_WEIGHT AS 실기배점
FROM OPEN_SUB OS
JOIN OPEN_COURSE OC ON OS.OC_CODE = OC.OC_CODE
JOIN COURSE CR ON OC.CR_CODE = CR.CR_CODE
JOIN CLASS CL ON OC.CL_CODE = CL.CL_CODE
JOIN SUB S ON OS.SUB_CODE = S.SUB_CODE
LEFT JOIN TEXTBOOK T ON OS.TB_CODE = T.TB_CODE
LEFT JOIN PROF P ON OS.PF_ID = P.PF_ID;


-- 관리자용 - 학생 목록 및 중도탈락 상태 뷰
CREATE OR REPLACE VIEW VIEW_ADMIN_STUDENT_LIST AS
SELECT
     ST.ST_ID
    ,ST.ST_NAME AS 학생이름
    ,CR.CR_NAME AS 과정명
    ,S.SUB_NAME AS 수강과목
    ,NVL(GR.ATT_SCORE, 0) + NVL(GR.WRT_SCORE, 0) + NVL(GR.PRC_SCORE, 0) AS 총점
    ,CASE 
     WHEN DO.DO_CODE IS NOT NULL 
     THEN 'Y' 
     ELSE 'N' 
     END AS 중도탈락여부
    ,DR.DR_REASON AS 탈락사유
FROM STUD ST
LEFT JOIN ENROLLMENT ER ON ST.ST_ID = ER.ST_ID
LEFT JOIN OPEN_COURSE OC ON ER.OC_CODE = OC.OC_CODE
LEFT JOIN COURSE CR ON OC.CR_CODE = CR.CR_CODE
LEFT JOIN OPEN_SUB OS ON OC.OC_CODE = OS.OC_CODE
LEFT JOIN SUB S ON OS.SUB_CODE = S.SUB_CODE
LEFT JOIN GRADE GR ON ER.ER_CODE = GR.ER_CODE AND OS.OS_CODE = GR.OS_CODE
LEFT JOIN DROP_OUT DO ON ER.ER_CODE = DO.ER_CODE
LEFT JOIN DROP_REASON DR ON DO.DR_CODE = DR.DR_CODE;

-- 교수자용 - 강의 과목 목록 뷰
CREATE OR REPLACE VIEW VIEW_PROF_SUBJECT_LIST AS
SELECT
    OS.PF_ID,
    OS.OS_CODE,
    S.SUB_NAME AS 과목명,
    OS.OS_SDATE AS 시작일시,
    OS.OS_EDATE AS 종료일시,
    T.TB_NAME AS 교재명,
    CR.CR_NAME AS 과정명,
    C.CL_NAME AS 강의실,
    OS.ATT_WEIGHT AS 출결배점,
    OS.WRT_WEIGHT AS 필기배점,
    OS.PRC_WEIGHT AS 실기배점,
    CASE
        WHEN SYSDATE < OS.OS_SDATE THEN '강의 예정'
        WHEN SYSDATE BETWEEN OS.OS_SDATE AND OS.OS_EDATE THEN '강의 중'
        ELSE '강의 종료'
    END AS 강의진행여부
FROM OPEN_SUB OS
JOIN SUB S ON OS.SUB_CODE = S.SUB_CODE
JOIN TEXTBOOK T ON OS.TB_CODE = T.TB_CODE
JOIN OPEN_COURSE OC ON OS.OC_CODE = OC.OC_CODE
JOIN COURSE CR ON OC.CR_CODE = CR.CR_CODE
JOIN CLASS C ON OC.CL_CODE = C.CL_CODE;


-- 교수자용 - 성적 입력 대상 학생 목록 뷰
CREATE OR REPLACE VIEW VIEW_PROF_SCORE_INPUT AS
SELECT
     OS.PF_ID
    ,OS.OS_CODE
    ,S.SUB_NAME AS 과목명
    ,ST.ST_ID
    ,ST.ST_NAME AS 학생명
    ,ER.ER_CODE
    ,GR.GR_CODE
    ,NVL(GR.ATT_SCORE, 0) AS 출결점수
    ,NVL(GR.WRT_SCORE, 0) AS 필기점수
    ,NVL(GR.PRC_SCORE, 0) AS 실기점수
    ,OS.ATT_WEIGHT AS 출결배점
    ,OS.WRT_WEIGHT AS 필기배점
    ,OS.PRC_WEIGHT AS 실기배점
FROM OPEN_SUB OS
JOIN SUB S ON OS.SUB_CODE = S.SUB_CODE
JOIN OPEN_COURSE OC ON OS.OC_CODE = OC.OC_CODE
JOIN ENROLLMENT ER ON OC.OC_CODE = ER.OC_CODE
JOIN STUD ST ON ER.ST_ID = ST.ST_ID
LEFT JOIN GRADE GR ON ER.ER_CODE = GR.ER_CODE AND OS.OS_CODE = GR.OS_CODE
LEFT JOIN DROP_OUT DO ON ER.ER_CODE = DO.ER_CODE
WHERE DO.DO_CODE IS NULL;

select *
from VIEW_PROF_SCORE_INPUT;

-- 교수자용 - 과목별 성적 및 등수 출력 뷰
CREATE OR REPLACE VIEW VIEW_PROF_SCORE_OUTPUT AS
SELECT
     OS.PF_ID
    ,OS.OS_CODE
    ,S.SUB_NAME AS 과목명
    ,OS.OS_SDATE AS 시작일시
    ,OS.OS_EDATE AS 종료일시
    ,T.TB_NAME AS 교재명
    ,ST.ST_ID
    ,ST.ST_NAME AS 학생명
    ,NVL(GR.ATT_SCORE, 0) AS 출결
    ,NVL(GR.WRT_SCORE, 0) AS 필기
    ,NVL(GR.PRC_SCORE, 0) AS 실기
    ,NVL(GR.ATT_SCORE, 0) + NVL(GR.WRT_SCORE, 0) + NVL(GR.PRC_SCORE, 0) AS 총점
    ,RANK() OVER 
      (
        PARTITION BY OS.OS_CODE
        ORDER BY NVL(GR.ATT_SCORE, 0) + NVL(GR.WRT_SCORE, 0) + NVL(GR.PRC_SCORE, 0) DESC
      ) AS 등수
    ,CASE 
     WHEN DO.DO_CODE IS NOT NULL 
     THEN 'Y' 
     ELSE 'N' 
     END AS 중도탈락여부
    ,DR.DR_REASON AS 탈락사유
FROM OPEN_SUB OS
JOIN SUB S ON OS.SUB_CODE = S.SUB_CODE
JOIN TEXTBOOK T ON OS.TB_CODE = T.TB_CODE
JOIN OPEN_COURSE OC ON OS.OC_CODE = OC.OC_CODE
JOIN ENROLLMENT ER ON OC.OC_CODE = ER.OC_CODE
JOIN STUD ST ON ER.ST_ID = ST.ST_ID
LEFT JOIN GRADE GR ON ER.ER_CODE = GR.ER_CODE AND OS.OS_CODE = GR.OS_CODE
LEFT JOIN DROP_OUT DO ON ER.ER_CODE = DO.ER_CODE
LEFT JOIN DROP_REASON DR ON DO.DR_CODE = DR.DR_CODE
WHERE OS.OS_EDATE < SYSDATE;

select *
from VIEW_PROF_SCORE_OUTPUT;


-- 학생용 - 수강 과목 목록 뷰
CREATE OR REPLACE VIEW VIEW_STUDENT_SUBJECT_LIST AS
SELECT
     ST.ST_ID
    ,OS.OS_CODE
    ,S.SUB_NAME AS 과목명
    ,OS.OS_SDATE AS 시작일시
    ,OS.OS_EDATE AS 종료일시
    ,CASE
     WHEN OS.OS_EDATE < SYSDATE THEN 'Y'
     ELSE 'N'
     END AS 수강완료여부
FROM STUD ST
JOIN ENROLLMENT ER ON ST.ST_ID = ER.ST_ID
JOIN OPEN_COURSE OC ON ER.OC_CODE = OC.OC_CODE
JOIN OPEN_SUB OS ON OC.OC_CODE = OS.OC_CODE
JOIN SUB S ON OS.SUB_CODE = S.SUB_CODE;

-- 학생용 - 성적 조회 뷰 (통합)
CREATE OR REPLACE VIEW VIEW_STUDENT_SCORE AS
SELECT
     ST.ST_ID
    ,ST.ST_NAME AS 학생이름
    ,CR.CR_NAME AS 과정명
    ,S.SUB_NAME AS 과목명
    ,OS.OS_SDATE AS 시작일시
    ,OS.OS_EDATE AS 종료일시
    ,T.TB_NAME AS 교재명
    ,(NVL(GR.ATT_SCORE, 0)*(os.ATT_WEIGHT/100)) AS 출결
    ,(NVL(GR.WRT_SCORE, 0)*(os.WRT_WEIGHT/100)) AS 필기
    ,(NVL(GR.PRC_SCORE, 0)*(OS.PRC_WEIGHT/100)) AS 실기
    ,(NVL(GR.ATT_SCORE, 0)*(os.ATT_WEIGHT/100)) +(NVL(GR.WRT_SCORE, 0)*(os.WRT_WEIGHT/100)) + (NVL(GR.PRC_SCORE, 0)*(OS.PRC_WEIGHT/100)) AS 총점
    ,RANK() OVER 
    (
        PARTITION BY OS.OS_CODE
        ORDER BY NVL(GR.ATT_SCORE, 0) + NVL(GR.WRT_SCORE, 0) + NVL(GR.PRC_SCORE, 0) DESC
    ) AS 등수
    ,CASE 
     WHEN DO.DO_CODE IS NOT NULL 
     THEN 'Y' 
     ELSE 'N' 
     END AS 중도탈락여부
    ,DR.DR_REASON AS 탈락사유
FROM STUD ST
JOIN ENROLLMENT ER ON ST.ST_ID = ER.ST_ID
JOIN OPEN_COURSE OC ON ER.OC_CODE = OC.OC_CODE
JOIN COURSE CR ON OC.CR_CODE = CR.CR_CODE
JOIN OPEN_SUB OS ON OC.OC_CODE = OS.OC_CODE
JOIN SUB S ON OS.SUB_CODE = S.SUB_CODE
JOIN TEXTBOOK T ON OS.TB_CODE = T.TB_CODE
LEFT JOIN GRADE GR ON ER.ER_CODE = GR.ER_CODE AND OS.OS_CODE = GR.OS_CODE
LEFT JOIN DROP_OUT DO ON ER.ER_CODE = DO.ER_CODE
LEFT JOIN DROP_REASON DR ON DO.DR_CODE = DR.DR_CODE
WHERE OS.OS_EDATE < SYSDATE;

